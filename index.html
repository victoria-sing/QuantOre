<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantOre</title>

    <link rel="icon" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* Base styles */
        html,
        body {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* Prevent scrolling on the body */
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #262626;
            /* Dark background */
        }

        /* Map container */
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            background-color: #262626;
            /* Match body/tile background */
        }

        /* UI Panels */
        .ui-panel {
            position: absolute;
            z-index: 1001;
            background-color: rgba(17, 24, 39, 0.85);
            /* bg-gray-900 with 85% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(55, 65, 81, 0.5);
            /* Refined border */
            color: white;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Neon Text Highlight */
        .text-neon-highlight {
            color: #39FF14;
            /* Neon Green */
            text-shadow: 0 0 4px #39FF14, 0 0 8px #39FF14;
        }

        /* Left and Right Sidebars */
        #sidebar-left,
        #sidebar-right {
            top: 1rem;
            /* Changed from 0 */
            /* height: 100vh; */
            /* Removed */
            max-height: calc(100vh - 2rem);
            /* Added */
            width: 22rem;
            /* w-88 */
            max-width: 90%;
            display: flex;
            flex-direction: column;
        }

        #sidebar-left {
            left: 1rem;
            /* Changed from 0 */
            border-radius: 0.75rem;
            /* rounded-xl */
            /* Made all-sided */
        }

        #sidebar-right {
            right: 1rem;
            /* Changed from 0 */
            border-radius: 0.75rem;
            /* rounded-xl */
            /* Made all-sided */
        }

        /* Hide sidebars on small screens */
        @media (max-width: 1024px) {
            #sidebar-left {
                transform: translateX(calc(-100% - 1rem));
                /* Adjusted for left: 1rem */
            }

            #sidebar-right {
                transform: translateX(calc(100% + 1rem));
                /* Adjusted for right: 1rem */
            }

            #sidebar-left.open,
            #sidebar-right.open {
                transform: translateX(0);
            }
        }

        /* Bottom Panel for Charts */
        #bottom-panel {
            bottom: 0;
            width: 100%;
            height: 40%;
            border-top-left-radius: 0.75rem;
            /* rounded-t-xl */
            border-top-right-radius: 0.75rem;
            /* rounded-t-xl */
            transform: translateY(100%);
        }

        #bottom-panel.open {
            transform: translateY(0);
        }

        /* Custom scrollbar for company list */
        #company-list {
            flex-grow: 0;
            /* Added */
            max-height: 65vh;
            /* Added reasonable max-height */
        }

        #company-list::-webkit-scrollbar {
            width: 6px;
        }

        #company-list::-webkit-scrollbar-track {
            background: rgba(55, 65, 81, 0.3);
            /* bg-gray-700 */
            border-radius: 3px;
        }

        #company-list::-webkit-scrollbar-thumb {
            background: #4B5563;
            /* bg-gray-600 */
            border-radius: 3px;
        }

        #company-list::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
            /* bg-gray-500 */
        }

        /* Loading Spinner */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            background: #1F2937;
            /* bg-gray-800 */
            color: #F3F4F6;
            /* bg-gray-100 */
            border-radius: 0.5rem;
        }

        .leaflet-popup-content {
            margin: 1rem;
        }

        .leaflet-popup-tip {
            background: #1F2937;
        }

        .leaflet-popup-close-button {
            color: #F3F4F6 !important;
            padding: 4px 4px 0 0 !important;
        }

        /* Mobile toggle button */
        #mobile-toggle-btn {
            z-index: 1002;
            position: absolute;
            top: 1rem;
            left: 1rem;
        }

        /* New UI Toggle Button */
        #toggle-ui-btn {
            z-index: 1002;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(17, 24, 39, 0.85);
            /* bg-gray-900 with 85% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(55, 65, 81, 0.5);
            /* Refined border */
            transition: opacity 0.3s;
        }

        /* Styles for hiding UI */
        #sidebar-left.ui-hidden {
            transform: translateX(calc(-100% - 1rem));
            /* Adjusted for left: 1rem */
        }

        #sidebar-right.ui-hidden {
            transform: translateX(calc(100% + 1rem));
            /* Adjusted for right: 1rem */
        }

        #bottom-panel.ui-hidden {
            transform: translateY(100%);
        }

        #mobile-toggle-btn.ui-hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        /* Input styles */
        .dark-input {
            background-color: rgba(55, 65, 81, 0.7);
            /* bg-gray-700, matches input */
            border: 1px solid #4B5563;
            /* border-gray-600 */
            color: white;
        }

        .dark-input::placeholder {
            color: #9CA3AF;
            /* text-gray-400 */
        }

        .dark-input:focus {
            outline: none;
            border-color: #39FF14;
            /* Neon Green */
            box-shadow: 0 0 0 2px rgba(57, 255, 20, 0.5);
            /* Neon Green glow */
        }

        /* Range slider styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4B5563;
            /* bg-gray-600 */
            border-radius: 3px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #39FF14;
            /* Neon Green */
            cursor: pointer;
            margin-top: -6px;
            /* Center thumb */
        }

        input[type=range]::-moz-range-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4B5563;
            border-radius: 3px;
        }

        input[type=range]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #39FF14;
            /* Neon Green */
            cursor: pointer;
            border: none;
        }

        /* Checkbox styles */
        input[type=checkbox] {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            background-color: rgba(55, 65, 81, 0.7);
            /* bg-gray-700, matches input */
            border: 1px solid #4B5563;
            /* border-gray-600, matches input */
            border-radius: 0.25rem;
            cursor: pointer;
            display: inline-block;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
        }

        input[type=checkbox]:checked {
            background-color: #39FF14;
            /* Neon Green */
            border-color: #39FF14;
            /* Neon Green */
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='black' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* UPDATED: Marker Glow Animation REMOVED */
        /* @keyframes pulse-glow block has been deleted */

        .leaflet-mine-marker.glowing-marker {
            /* This applies the yellow border color */
            stroke: #FFFF00 !important;
            /* Bright Yellow border */
            stroke-width: 3 !important;
            /* Make border thicker for highlight */
            /* animation: ... REMOVED */
        }

        /* NEW: Add subtle glow to all markers */
        .leaflet-mine-marker {
            /* transition: ... REMOVED */
            /* filter: ... REMOVED */
        }

        /* .leaflet-mine-marker.glowing-marker { ... } */
        /* This redundant block has been deleted */
    </style>
    <style>
        /* === Neon Chatbox Styles === */

        /* Neon green glowing border for chatbot popup */
        #chatbot-panel {
            border: 2px solid #39FF14;
            box-shadow:
                0 0 10px #39FF14,
                0 0 20px #39FF14,
                0 0 30px #39FF14;
            border-radius: 12px;
            transition: all 0.3s ease-in-out;
        }

        /* Remove glow when hidden */
        #chatbot-panel.hidden {
            box-shadow: none;
            border: none;
        }

        /* Neon green glowing text */
        .text-neon-highlight {
            color: #39FF14;
            text-shadow: 0 0 4px #39FF14, 0 0 8px #39FF14;
        }
    </style>

</head>

<body class="bg-gray-900">
    <script src="data.js"></script>

    <div id="map"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <span>Loading Geo-Financial Data...</span>
    </div>

    <button id="mobile-toggle-btn" class="p-2 bg-gray-900/80 backdrop-blur-md text-white rounded-lg lg:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
    </button>

    <button id="toggle-ui-btn" class="p-2 text-white rounded-lg">
        <svg id="icon-hide" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg>
        <svg id="icon-show" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7 1.274-4.057 5.064-7 9.542-7 .847 0 1.67.11 2.458.31M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M17.593 17.593l-1.414-1.414M1.172 1.172l1.414 1.414m5.21 5.21l-1.414-1.414M17.593 1.172l-1.414 1.414m-5.21 5.21l-1.414 1.414M1.172 17.593l1.414-1.414m5.21-5.21l-1.414 1.414" />
        </svg>
    </button>

    <div id="sidebar-left" class="ui-panel p-4">
        <h1 class="text-2xl font-bold mb-4 text-neon-highlight">QuantOre</h1>
        <div class="mb-4">
            <input type="text" id="search-box" placeholder="Search companies..."
                class="w-full p-2 rounded-lg dark-input">
        </div>
        <div id="company-list" class="flex-grow overflow-y-auto space-y-1 pr-2">
        </div>
    </div>

    <div id="sidebar-right" class="ui-panel p-4">
        <h2 class="text-xl font-semibold mb-6 text-neon-highlight">Layers & Analysis</h2>

        <div class="space-y-4 mb-8">
            <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="toggle-mines" checked>
                <span class="text-gray-200">Mining Operations</span>
            </label>
            <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="toggle-weather">
                <span class="text-gray-200">Light Mode</span>
            </label>
        </div>

        <div class="space-y-3">
            <label for="year-slider" class="text-gray-300">Select Year for Risk Analysis</label>
            <input type="range" id="year-slider" min="2025" max="2028" value="2025" step="0.5" class="w-full">
            <div class="text-center text-xl font-bold text-neon-highlight" id="selected-year">2025</div>
        </div>
    </div>

    <div id="bottom-panel" class="ui-panel p-4">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-3">
                <button id="prev-company-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="company-info-header" class="text-xl font-bold text-neon-highlight">Select a Company</h2>
                <button id="next-company-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <button id="close-panel-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div id="charts-container" class="h-[calc(100%-4.5rem)] relative">
            <div id="chart-loader">
                <div class="spinner"></div>
                <span class="text-sm text-gray-400">Fetching Live Data...</span>
            </div>
            <div class="chart-wrapper h-full">
                <canvas id="stock-chart"></canvas>
                <canvas id="financials-chart" style="display: none;"></canvas>
            </div>
        </div>
        <div class="flex justify-center items-center gap-4 mt-2">
            <button id="prev-chart-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <span id="chart-title" class="font-semibold text-gray-300 w-32 text-center">Stock Price</span>
            <button id="next-chart-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>


    <script>
        // Import necessary data from data.js

        // ----- APPLICATION STATE -----
        let map;
        let companyData = [];
        let mineLayer;
        let weatherLayer;
        let disasterLayer;
        let targetedRiskLayer;
        let companyMarkers = {};
        let currentCompanyIndex = -1; // Track the currently selected company
        let currentChartIndex = 0; // 0 = stock, 1 = market forecast, 2 = financials
        const chartTitles = ['Stock Price', 'Market Forecast', 'Financials'];
        const charts = {
            stock: null,
            financials: null
        };
        let isUiHidden = false;
        let financialsCache = {}; // Cache for financial API calls

        // API Key
        const ALPHA_VANTAGE_API_KEY = '9BYTM0MFLXJ0UVN8';

        /**
         * Generates a massive mock financial dataset for 50 companies over 20 years.
         * This function's return value is > 12,000 lines long.
         */
        function generateMockFinancialData(companies) {
            const data = {};
            const startDate = new Date('2005-01-01');

            // Helper to add months
            function addMonths(date, months) {
                const d = new Date(date);
                d.setMonth(d.getMonth() + months);
                return d;
            }

            // Helper to format date as YYYY-MM
            function formatDate(date) {
                return date.toISOString().slice(0, 7);
            }

            return {
                "BHP": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (142000 + Math.random() * 50000 + i * 100).toFixed(2),
                        revenue: (30000 + Math.random() * 10000 + i * 50).toFixed(2),
                        earnings: (8000 + Math.random() * 5000 + i * 20).toFixed(2),
                        debt: (15000 + Math.random() * 5000 - i * 10).toFixed(2),
                        price: (55 + Math.random() * 10 + i * 0.1).toFixed(2)
                    };
                }),
                "601088.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (115000 + Math.random() * 40000 + i * 90).toFixed(2),
                        revenue: (25000 + Math.random() * 8000 + i * 40).toFixed(2),
                        earnings: (7000 + Math.random() * 4000 + i * 15).toFixed(2),
                        debt: (20000 + Math.random() * 6000 - i * 5).toFixed(2),
                        price: (5 + Math.random() * 2 + i * 0.01).toFixed(2)
                    };
                }),
                "RIO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (112000 + Math.random() * 45000 + i * 95).toFixed(2),
                        revenue: (28000 + Math.random() * 9000 + i * 45).toFixed(2),
                        earnings: (7500 + Math.random() * 4500 + i * 18).toFixed(2),
                        debt: (18000 + Math.random() * 5500 - i * 8).toFixed(2),
                        price: (70 + Math.random() * 15 + i * 0.12).toFixed(2)
                    };
                }),
                "601899.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (110000 + Math.random() * 35000 + i * 85).toFixed(2),
                        revenue: (22000 + Math.random() * 7000 + i * 35).toFixed(2),
                        earnings: (6000 + Math.random() * 3000 + i * 12).toFixed(2),
                        debt: (25000 + Math.random() * 7000 + i * 5).toFixed(2),
                        price: (4 + Math.random() * 1.5 + i * 0.005).toFixed(2)
                    };
                }),
                "SCCO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (105000 + Math.random() * 55000 + i * 110).toFixed(2),
                        revenue: (20000 + Math.random() * 6000 + i * 30).toFixed(2),
                        earnings: (5000 + Math.random() * 2500 + i * 10).toFixed(2),
                        debt: (10000 + Math.random() * 3000 + i * 15).toFixed(2),
                        price: (129 + Math.random() * 30 + i * 0.2).toFixed(2)
                    };
                }),
                "NEM": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (91000 + Math.random() * 30000 + i * 70).toFixed(2),
                        revenue: (18000 + Math.random() * 5000 + i * 25).toFixed(2),
                        earnings: (4000 + Math.random() * 2000 + i * 8).toFixed(2),
                        debt: (12000 + Math.random() * 4000 - i * 3).toFixed(2),
                        price: (83 + Math.random() * 20 + i * 0.05).toFixed(2)
                    };
                }),
                "AEM": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (82000 + Math.random() * 25000 + i * 60).toFixed(2),
                        revenue: (16000 + Math.random() * 4000 + i * 20).toFixed(2),
                        earnings: (3500 + Math.random() * 1500 + i * 7).toFixed(2),
                        debt: (8000 + Math.random() * 2000 + i * 10).toFixed(2),
                        price: (163 + Math.random() * 40 + i * 0.15).toFixed(2)
                    };
                }),
                "1211.SR": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (66000 + Math.random() * 20000 + i * 50).toFixed(2),
                        revenue: (14000 + Math.random() * 3000 + i * 15).toFixed(2),
                        earnings: (3000 + Math.random() * 1000 + i * 5).toFixed(2),
                        debt: (22000 + Math.random() * 6000 + i * 12).toFixed(2),
                        price: (17 + Math.random() * 5 + i * 0.03).toFixed(2)
                    };
                }),
                "GMBXF": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (63000 + Math.random() * 18000 + i * 45).toFixed(2),
                        revenue: (13000 + Math.random() * 2500 + i * 12).toFixed(2),
                        earnings: (2800 + Math.random() * 800 + i * 4).toFixed(2),
                        debt: (19000 + Math.random() * 5000 + i * 8).toFixed(2),
                        price: (8 + Math.random() * 2 + i * 0.01).toFixed(2)
                    };
                }),
                "FCX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (59000 + Math.random() * 22000 + i * 55).toFixed(2),
                        revenue: (12000 + Math.random() * 3500 + i * 18).toFixed(2),
                        earnings: (2500 + Math.random() * 1200 + i * 6).toFixed(2),
                        debt: (17000 + Math.random() * 4000 - i * 2).toFixed(2),
                        price: (41 + Math.random() * 10 + i * 0.08).toFixed(2)
                    };
                }),
                "B": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (55000 + Math.random() * 15000 + i * 40).toFixed(2),
                        revenue: (11000 + Math.random() * 2000 + i * 10).toFixed(2),
                        earnings: (2200 + Math.random() * 700 + i * 3).toFixed(2),
                        debt: (13000 + Math.random() * 3000 + i * 3).toFixed(2),
                        price: (32 + Math.random() * 8 + i * 0.04).toFixed(2)
                    };
                }),
                "GLEN.L": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (55000 + Math.random() * 16000 + i * 42).toFixed(2),
                        revenue: (40000 + Math.random() * 10000 + i * 50).toFixed(2),
                        earnings: (2000 + Math.random() * 1000 + i * 2).toFixed(2),
                        debt: (30000 + Math.random() * 8000 + i * 20).toFixed(2),
                        price: (5 + Math.random() * 1 + i * 0.005).toFixed(2)
                    };
                }),
                "VALE": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (54000 + Math.random() * 17000 + i * 44).toFixed(2),
                        revenue: (10000 + Math.random() * 3000 + i * 14).toFixed(2),
                        earnings: (2100 + Math.random() * 900 + i * 4).toFixed(2),
                        debt: (21000 + Math.random() * 5000 - i * 10).toFixed(2),
                        price: (12 + Math.random() * 4 + i * 0.02).toFixed(2)
                    };
                }),
                "603993.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (52000 + Math.random() * 14000 + i * 38).toFixed(2),
                        revenue: (9000 + Math.random() * 2000 + i * 9).toFixed(2),
                        earnings: (1800 + Math.random() * 600 + i * 2).toFixed(2),
                        debt: (28000 + Math.random() * 7000 + i * 18).toFixed(2),
                        price: (2 + Math.random() * 0.5 + i * 0.003).toFixed(2)
                    };
                }),
                "WPM": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (49000 + Math.random() * 13000 + i * 36).toFixed(2),
                        revenue: (1000 + Math.random() * 200 + i * 1).toFixed(2),
                        earnings: (500 + Math.random() * 100 + i * 0.5).toFixed(2),
                        debt: (2000 + Math.random() * 500 - i * 1).toFixed(2),
                        price: (110 + Math.random() * 30 + i * 0.1).toFixed(2)
                    };
                }),
                "FMG.AX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (46000 + Math.random() * 12000 + i * 34).toFixed(2),
                        revenue: (8000 + Math.random() * 1500 + i * 8).toFixed(2),
                        earnings: (1600 + Math.random() * 500 + i * 1.5).toFixed(2),
                        debt: (5000 + Math.random() * 1000 + i * 2).toFixed(2),
                        price: (14 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                }),
                "AAL.L": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (45000 + Math.random() * 11000 + i * 32).toFixed(2),
                        revenue: (7000 + Math.random() * 1200 + i * 7).toFixed(2),
                        earnings: (1400 + Math.random() * 400 + i * 1).toFixed(2),
                        debt: (14000 + Math.random() * 3000 - i * 4).toFixed(2),
                        price: (41 + Math.random() * 10 + i * 0.07).toFixed(2)
                    };
                }),
                "CCJ": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (43000 + Math.random() * 10000 + i * 30).toFixed(2),
                        revenue: (1500 + Math.random() * 300 + i * 2).toFixed(2),
                        earnings: (300 + Math.random() * 50 + i * 0.2).toFixed(2),
                        debt: (3000 + Math.random() * 800 + i * 1).toFixed(2),
                        price: (98 + Math.random() * 25 + i * 0.18).toFixed(2)
                    };
                }),
                "FNV": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (41000 + Math.random() * 9000 + i * 28).toFixed(2),
                        revenue: (1200 + Math.random() * 250 + i * 1.5).toFixed(2),
                        earnings: (600 + Math.random() * 120 + i * 0.8).toFixed(2),
                        debt: (1000 + Math.random() * 200).toFixed(2),
                        price: (212 + Math.random() * 50 + i * 0.25).toFixed(2)
                    };
                }),
                "BYAN.JK": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (40000 + Math.random() * 8000 + i * 26).toFixed(2),
                        revenue: (6000 + Math.random() * 1000 + i * 6).toFixed(2),
                        earnings: (1200 + Math.random() * 300 + i * 0.9).toFixed(2),
                        debt: (7000 + Math.random() * 1500 + i * 3).toFixed(2),
                        price: (1.2 + Math.random() * 0.3 + i * 0.002).toFixed(2)
                    };
                }),
                "GFI": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (40000 + Math.random() * 7500 + i * 25).toFixed(2),
                        revenue: (5000 + Math.random() * 800 + i * 5).toFixed(2),
                        earnings: (1000 + Math.random() * 200 + i * 0.7).toFixed(2),
                        debt: (8000 + Math.random() * 1200 - i * 2).toFixed(2),
                        price: (45 + Math.random() * 10 + i * 0.08).toFixed(2)
                    };
                }),
                "ANTO.L": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (39000 + Math.random() * 7000 + i * 24).toFixed(2),
                        revenue: (4500 + Math.random() * 700 + i * 4.5).toFixed(2),
                        earnings: (900 + Math.random() * 150 + i * 0.6).toFixed(2),
                        debt: (6000 + Math.random() * 1000 + i * 1).toFixed(2),
                        price: (39 + Math.random() * 8 + i * 0.06).toFixed(2)
                    };
                }),
                "PLZL.ME": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (38000 + Math.random() * 6500 + i * 23).toFixed(2),
                        revenue: (4000 + Math.random() * 600 + i * 4).toFixed(2),
                        earnings: (1500 + Math.random() * 300 + i * 1).toFixed(2),
                        debt: (4000 + Math.random() * 800 + i * 2).toFixed(2),
                        price: (28 + Math.random() * 5 + i * 0.04).toFixed(2)
                    };
                }),
                "AU": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (38000 + Math.random() * 6000 + i * 22).toFixed(2),
                        revenue: (4800 + Math.random() * 750 + i * 4.8).toFixed(2),
                        earnings: (800 + Math.random() * 180 + i * 0.5).toFixed(2),
                        debt: (9000 + Math.random() * 1400 - i * 3).toFixed(2),
                        price: (76 + Math.random() * 15 + i * 0.1).toFixed(2)
                    };
                }),
                "KGC": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (32000 + Math.random() * 5000 + i * 20).toFixed(2),
                        revenue: (3500 + Math.random() * 500 + i * 3.5).toFixed(2),
                        earnings: (700 + Math.random() * 100 + i * 0.3).toFixed(2),
                        debt: (5500 + Math.random() * 900 + i * 1).toFixed(2),
                        price: (26 + Math.random() * 6 + i * 0.03).toFixed(2)
                    };
                }),
                "NTR": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (31000 + Math.random() * 4500 + i * 19).toFixed(2),
                        revenue: (10000 + Math.random() * 2000 + i * 10).toFixed(2),
                        earnings: (2000 + Math.random() * 400 + i * 2).toFixed(2),
                        debt: (15000 + Math.random() * 2500 + i * 5).toFixed(2),
                        price: (65 + Math.random() * 12 + i * 0.09).toFixed(2)
                    };
                }),
                "COALINDIA.NS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (30000 + Math.random() * 4000 + i * 18).toFixed(2),
                        revenue: (12000 + Math.random() * 2500 + i * 12).toFixed(2),
                        earnings: (2500 + Math.random() * 500 + i * 2.5).toFixed(2),
                        debt: (3000 + Math.random() * 600 + i * 0.5).toFixed(2),
                        price: (5 + Math.random() * 1 + i * 0.005).toFixed(2)
                    };
                }),
                "600111.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (29000 + Math.random() * 3500 + i * 17).toFixed(2),
                        revenue: (3000 + Math.random() * 400 + i * 3).toFixed(2),
                        earnings: (600 + Math.random() * 80 + i * 0.2).toFixed(2),
                        debt: (6000 + Math.random() * 1000 + i * 2).toFixed(2),
                        price: (8 + Math.random() * 2 + i * 0.01).toFixed(2)
                    };
                }),
                "GMKN.ME": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (26000 + Math.random() * 3000 + i * 16).toFixed(2),
                        revenue: (9000 + Math.random() * 1500 + i * 9).toFixed(2),
                        earnings: (1800 + Math.random() * 300 + i * 1.8).toFixed(2),
                        debt: (7000 + Math.random() * 1100 + i * 3).toFixed(2),
                        price: (1.8 + Math.random() * 0.5 + i * 0.002).toFixed(2)
                    };
                }),
                "600547.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (25000 + Math.random() * 2800 + i * 15).toFixed(2),
                        revenue: (5000 + Math.random() * 700 + i * 5).toFixed(2),
                        earnings: (1000 + Math.random() * 150 + i * 1).toFixed(2),
                        debt: (8000 + Math.random() * 1300 + i * 4).toFixed(2),
                        price: (5.7 + Math.random() * 1.2 + i * 0.008).toFixed(2)
                    };
                }),
                "601898.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (25000 + Math.random() * 2500 + i * 14).toFixed(2),
                        revenue: (11000 + Math.random() * 2200 + i * 11).toFixed(2),
                        earnings: (2200 + Math.random() * 450 + i * 2.2).toFixed(2),
                        debt: (9000 + Math.random() * 1400 + i * 4.5).toFixed(2),
                        price: (2 + Math.random() * 0.4 + i * 0.003).toFixed(2)
                    };
                }),
                "NST.AX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (24000 + Math.random() * 2300 + i * 13).toFixed(2),
                        revenue: (2500 + Math.random() * 300 + i * 2.5).toFixed(2),
                        earnings: (500 + Math.random() * 60 + i * 0.1).toFixed(2),
                        debt: (2000 + Math.random() * 300 + i * 0.5).toFixed(2),
                        price: (17 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                }),
                "VEDL.NS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (24000 + Math.random() * 2000 + i * 12).toFixed(2),
                        revenue: (13000 + Math.random() * 3000 + i * 13).toFixed(2),
                        earnings: (2600 + Math.random() * 600 + i * 2.6).toFixed(2),
                        debt: (16000 + Math.random() * 3000 + i * 6).toFixed(2),
                        price: (6.3 + Math.random() * 1.5 + i * 0.009).toFixed(2)
                    };
                }),
                "FNLPF": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (24000 + Math.random() * 1800 + i * 11).toFixed(2),
                        revenue: (1300 + Math.random() * 200 + i * 1.3).toFixed(2),
                        earnings: (300 + Math.random() * 50 + i * 0.3).toFixed(2),
                        debt: (1500 + Math.random() * 200 + i * 0.2).toFixed(2),
                        price: (32 + Math.random() * 7 + i * 0.05).toFixed(2)
                    };
                }),
                "TECK": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (23000 + Math.random() * 1600 + i * 10).toFixed(2),
                        revenue: (10000 + Math.random() * 1800 + i * 10).toFixed(2),
                        earnings: (2000 + Math.random() * 350 + i * 2).toFixed(2),
                        debt: (10000 + Math.random() * 1500 - i * 3).toFixed(2),
                        price: (47 + Math.random() * 10 + i * 0.08).toFixed(2)
                    };
                }),
                "600188.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (20000 + Math.random() * 1500 + i * 9).toFixed(2),
                        revenue: (14000 + Math.random() * 2800 + i * 14).toFixed(2),
                        earnings: (2800 + Math.random() * 550 + i * 2.8).toFixed(2),
                        debt: (11000 + Math.random() * 1600 + i * 5).toFixed(2),
                        price: (2.3 + Math.random() * 0.5 + i * 0.003).toFixed(2)
                    };
                }),
                "FM.TO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (20000 + Math.random() * 1400 + i * 8.5).toFixed(2),
                        revenue: (6000 + Math.random() * 900 + i * 6).toFixed(2),
                        earnings: (1200 + Math.random() * 200 + i * 1.2).toFixed(2),
                        debt: (12000 + Math.random() * 1800 - i * 5).toFixed(2),
                        price: (24 + Math.random() * 5 + i * 0.03).toFixed(2)
                    };
                }),
                "002460.SZ": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (19000 + Math.random() * 1300 + i * 8).toFixed(2),
                        revenue: (2000 + Math.random() * 300 + i * 2).toFixed(2),
                        earnings: (400 + Math.random() * 60 + i * 0.4).toFixed(2),
                        debt: (4000 + Math.random() * 600 + i * 1).toFixed(2),
                        price: (10 + Math.random() * 2 + i * 0.015).toFixed(2)
                    };
                }),
                "603799.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (18000 + Math.random() * 1200 + i * 7.5).toFixed(2),
                        revenue: (3000 + Math.random() * 400 + i * 3).toFixed(2),
                        earnings: (600 + Math.random() * 80 + i * 0.6).toFixed(2),
                        debt: (5000 + Math.random() * 700 + i * 1.5).toFixed(2),
                        price: (10 + Math.random() * 2 + i * 0.015).toFixed(2)
                    };
                }),
                "LUG.TO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (18000 + Math.random() * 1100 + i * 7).toFixed(2),
                        revenue: (500 + Math.random() * 100 + i * 0.5).toFixed(2),
                        earnings: (100 + Math.random() * 20 + i * 0.1).toFixed(2),
                        debt: (1000 + Math.random() * 150 + i * 0.2).toFixed(2),
                        price: (76 + Math.random() * 15 + i * 0.12).toFixed(2)
                    };
                }),
                "PE&OLES.MX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 1000 + i * 6.5).toFixed(2),
                        revenue: (4000 + Math.random() * 600 + i * 4).toFixed(2),
                        earnings: (800 + Math.random() * 120 + i * 0.8).toFixed(2),
                        debt: (6000 + Math.random() * 800 - i * 1).toFixed(2),
                        price: (44 + Math.random() * 9 + i * 0.07).toFixed(2)
                    };
                }),
                "RGLD": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 900 + i * 6).toFixed(2),
                        revenue: (600 + Math.random() * 110 + i * 0.6).toFixed(2),
                        earnings: (200 + Math.random() * 30 + i * 0.2).toFixed(2),
                        debt: (500 + Math.random() * 50).toFixed(2),
                        price: (204 + Math.random() * 40 + i * 0.2).toFixed(2)
                    };
                }),
                "600489.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 800 + i * 5.5).toFixed(2),
                        revenue: (3500 + Math.random() * 500 + i * 3.5).toFixed(2),
                        earnings: (700 + Math.random() * 90 + i * 0.7).toFixed(2),
                        debt: (7000 + Math.random() * 1000 + i * 2).toFixed(2),
                        price: (3.5 + Math.random() * 0.7 + i * 0.004).toFixed(2)
                    };
                }),
                "0ZQ.F": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 700 + i * 5).toFixed(2),
                        revenue: (2000 + Math.random() * 250 + i * 2).toFixed(2),
                        earnings: (800 + Math.random() * 100 + i * 0.8).toFixed(2),
                        debt: (1000 + Math.random() * 100).toFixed(2),
                        price: (57 + Math.random() * 11 + i * 0.09).toFixed(2)
                    };
                }),
                "PAAS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 600 + i * 4.5).toFixed(2),
                        revenue: (1500 + Math.random() * 200 + i * 1.5).toFixed(2),
                        earnings: (100 + Math.random() * 20 + i * 0.1).toFixed(2),
                        debt: (2000 + Math.random() * 300 - i * 0.5).toFixed(2),
                        price: (40 + Math.random() * 8 + i * 0.06).toFixed(2)
                    };
                }),
                "IVN.TO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (16000 + Math.random() * 500 + i * 4).toFixed(2),
                        revenue: (200 + Math.random() * 50 + i * 0.2).toFixed(2),
                        earnings: (-50 + Math.random() * 10 + i * 0.05).toFixed(2),
                        debt: (3000 + Math.random() * 400 + i * 1).toFixed(2),
                        price: (12 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                }),
                "EVN.AX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (15000 + Math.random() * 400 + i * 3.5).toFixed(2),
                        revenue: (1800 + Math.random() * 220 + i * 1.8).toFixed(2),
                        earnings: (300 + Math.random() * 40 + i * 0.3).toFixed(2),
                        debt: (1500 + Math.random() * 200 + i * 0.3).toFixed(2),
                        price: (7.6 + Math.random() * 1.5 + i * 0.01).toFixed(2)
                    };
                }),
                "1818.HK": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (15000 + Math.random() * 300 + i * 3).toFixed(2),
                        revenue: (2200 + Math.random() * 280 + i * 2.2).toFixed(2),
                        earnings: (400 + Math.random() * 50 + i * 0.4).toFixed(2),
                        debt: (4000 + Math.random() * 500 + i * 1.2).toFixed(2),
                        price: (4.1 + Math.random() * 0.8 + i * 0.006).toFixed(2)
                    };
                }),
                "AGI": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (14000 + Math.random() * 200 + i * 2.5).toFixed(2),
                        revenue: (800 + Math.random() * 100 + i * 0.8).toFixed(2),
                        earnings: (150 + Math.random() * 20 + i * 0.15).toFixed(2),
                        debt: (300 + Math.random() * 30).toFixed(2),
                        price: (35 + Math.random() * 7 + i * 0.05).toFixed(2)
                    };
                }),
                "METSO.HE": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (14000 + Math.random() * 100 + i * 2).toFixed(2),
                        revenue: (5000 + Math.random() * 600 + i * 5).toFixed(2),
                        earnings: (500 + Math.random() * 60 + i * 0.5).toFixed(2),
                        debt: (2000 + Math.random() * 200 + i * 0.4).toFixed(2),
                        price: (17 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                })
            };
        }

        // ----- NEW REAL DATA PARSING (imported from data.js) -----

        // Helper to parse coordinates like "119.75° E" or "-22.55° S"
        function parseCoordinates(lngStr, latStr) {
            // Use Math.abs(parseFloat(...)) to ignore existing negative signs
            // which might be used inconsistently with S/W designators
            const lngVal = Math.abs(parseFloat(lngStr));
            const latVal = Math.abs(parseFloat(latStr));

            // Apply sign based on N/S/E/W
            const lng = lngStr.includes('W') ? -lngVal : lngVal;
            const lat = latStr.includes('S') ? -latVal : latVal;

            return [lng, lat];
        }

        /**
         * Parses the new mining sites CSV and converts it to GeoJSON
         */
        function parseAndProcessMineData(csvData, top50Companies) {
            const parsed = Papa.parse(csvData.trim(), { header: true, skipEmptyLines: true });
            const features = [];
            let currentCompany = null;
            let currentRank = null;

            // Create a lookup map to find a symbol by company name
            const companySymbolMap = new Map();
            top50Companies.forEach(c => {
                companySymbolMap.set(c.Name, c.Symbol);
            });
            // Add known aliases
            companySymbolMap.set('Fortescue', 'FMG.AX');
            companySymbolMap.set('Barrick Gold', 'B'); // 'B' is not unique, 'GOLD' is better but CSV uses 'B'
            companySymbolMap.set('Glencore', 'GLEN.L');
            companySymbolMap.set('Anglo American', 'AAL.L');

            parsed.data.forEach(row => {
                // Handle "carry-down" logic for merged cells
                if (row.Company && row.Company.trim()) {
                    currentCompany = row.Company.trim();
                }
                if (row.Rank && row.Rank.trim()) {
                    currentRank = row.Rank.trim();
                }

                // Skip rows without coordinates
                if (!row.Longitude || !row.Latitude || !currentCompany) return;

                // Skip "See Other" rows
                if (row['Site Name'].startsWith('See ')) return;

                const [lng, lat] = parseCoordinates(row.Longitude, row.Latitude);

                // Skip if coordinates are invalid
                if (isNaN(lng) || isNaN(lat)) {
                    console.warn('Skipping row with invalid coordinates:', row);
                    return;
                }

                // Find the matching company symbol from the Top 50 list
                const companySymbol = companySymbolMap.get(currentCompany) || null;

                // Determine primary commodity for coloring
                const primaryCommodity = row.Commondity.split(/[,-]/)[0].trim();

                features.push({
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [lng, lat]
                    },
                    properties: {
                        rank: currentRank,
                        siteName: row['Site Name'],
                        companyName: currentCompany,
                        companySymbol: companySymbol,
                        commodity: row.Commondity,
                        primaryCommodity: primaryCommodity,
                        lat: lat,
                        lng: lng
                    }
                });
            });

            return { type: "FeatureCollection", features: features };
        }


        // ----- MOCK DATA ASSIGNMENT -----
        // We call the generator functions to get the massive data objects.
        let MOCK_FINANCIAL_DATA = {};
        let MOCK_MINE_GEOJSON = {};


        // ----- INITIALIZATION -----
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            // 1. Load and parse company data from the embedded CSV string
            try {
                const parsed = Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true
                });
                companyData = parsed.data.slice(0, 50); // Get top 50

                // 2. Generate the massive mock financial datasets
                MOCK_FINANCIAL_DATA = generateMockFinancialData(companyData);

                // 3. Load and parse the REAL mine data
                MOCK_MINE_GEOJSON = parseAndProcessMineData(miningSitesCsvData, companyData);

            } catch (error) {
                console.error("Error loading data:", error);
                return;
            }

            // 3. Initialize the map
            initMap();

            // 4. Populate UI elements
            populateCompanyList();

            // 5. Add map layers
            addMineLayer();

            // 6. Setup all event listeners
            setupEventListeners();

            // 7. Hide loading overlay
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function initMap() {
            map = L.map('map', {
                center: [20, 0], // Center of the world
                zoom: 2,
                worldCopyJump: true,
                layers: [
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    })
                ]
            });

            // Custom zoom control position
            map.zoomControl.setPosition('bottomright');
        }

        // ----- UI POPULATION -----

        function populateCompanyList() {
            const listContainer = document.getElementById('company-list');
            listContainer.innerHTML = ''; // Clear existing

            companyData.forEach((company, index) => {
                const item = document.createElement('div');
                item.className = 'p-3 rounded-lg hover:bg-gray-800/70 cursor-pointer transition-colors'; // Changed hover to bg-gray-800
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${company.Rank}. ${company.Name}</span>
                        <span class="text-xs text-gray-400">${company.Symbol}</span>
                    </div>
                    <div class="text-sm text-gray-300">${company.country}</div>
                `;
                item.addEventListener('click', () => onCompanySelect(index));
                listContainer.appendChild(item);
            });
        }

        function filterCompanyList() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const items = document.getElementById('company-list').children;

            Array.from(items).forEach(item => {
                const text = item.innerText.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ----- MAP LAYERS -----

        function addMineLayer() {
            if (mineLayer && map.hasLayer(mineLayer)) {
                map.removeLayer(mineLayer);
            }

            // Reset markers map
            companyMarkers = {};

            mineLayer = L.geoJSON(MOCK_MINE_GEOJSON, {
                pointToLayer: (feature, latlng) => {
                    const primary = feature.properties.primaryCommodity;
                    const color = commodityColors[primary] || commodityColors['default'];

                    const marker = L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: color,
                        color: color, // Match fill color (removes white border)
                        weight: 1,    // 1px border so it looks solid
                        opacity: 1,
                        fillOpacity: 0.9, // Make fill slightly more vibrant
                        className: 'leaflet-mine-marker' // Add class for CSS targeting
                    });

                    // Store marker by company symbol
                    const symbol = feature.properties.companySymbol;
                    if (!companyMarkers[symbol]) {
                        companyMarkers[symbol] = [];
                    }
                    companyMarkers[symbol].push(marker);

                    return marker;
                },
                onEachFeature: (feature, layer) => {
                    // Create popup content
                    const props = feature.properties;
                    const primaryColor = commodityColors[props.primaryCommodity] || commodityColors['default'];

                    const popupContent = `
                        <div class="text-base font-bold">${props.siteName}</div>
                        <div class="text-sm">Company: ${props.companyName}</div>
                        <div class="text-sm mt-2">Commodities: <span class="font-semibold" style="color: ${primaryColor}">${props.commodity}</span></div>
                        <div class="text-xs text-gray-400 mt-2">Coords: ${props.lat.toFixed(4)}, ${props.lng.toFixed(4)}</div>
                    `;
                    layer.bindPopup(popupContent);

                    // Add click event to select company
                    layer.on('click', () => {
                        const index = companyData.findIndex(c => c.Symbol === props.companySymbol);
                        if (index > -1) onCompanySelect(index);
                    });
                }
            });

            mineLayer.addTo(map);
        }

        function toggleWeatherLayer() {
            const isChecked = document.getElementById('toggle-weather').checked;
            if (isChecked) {
                // SIMULATION: In a real app, this would be a weather tile URL.
                // We will simulate it with a semi-transparent blue layer.
                weatherLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    opacity: 1,
                    attribution: 'Simulated Weather Layer'
                }).addTo(map);
            } else if (weatherLayer && map.hasLayer(weatherLayer)) {
                map.removeLayer(weatherLayer);
            }
        }


        // ----- EVENT LISTENERS -----

        function setupEventListeners() {
            // Search Box
            document.getElementById('search-box').addEventListener('input', filterCompanyList);

            // Layer Toggles
            document.getElementById('toggle-mines').addEventListener('change', () => {
                document.getElementById('toggle-mines').checked ? addMineLayer() : map.removeLayer(mineLayer);
            });
            document.getElementById('toggle-weather').addEventListener('change', toggleWeatherLayer);



            // Year Slider
            const yearSlider = document.getElementById('year-slider');
            const yearDisplay = document.getElementById('selected-year');
            yearSlider.addEventListener('input', (e) => {
                yearDisplay.innerText = e.target.value;
            });
            yearSlider.addEventListener('change', (e) => {
                // Update risk layers when slider value is confirmed
                updateDisasterLayer();
            });

            // Bottom Panel Close
            document.getElementById('close-panel-btn').addEventListener('click', () => {
                document.getElementById('bottom-panel').classList.remove('open');
            });

            // Chart navigation (Company)
            document.getElementById('prev-company-btn').addEventListener('click', selectPreviousCompany);
            document.getElementById('next-company-btn').addEventListener('click', selectNextCompany);

            // Chart navigation (Chart Type)
            document.getElementById('prev-chart-btn').addEventListener('click', selectPreviousChart);
            document.getElementById('next-chart-btn').addEventListener('click', selectNextChart);

            // Mobile Toggle
            document.getElementById('mobile-toggle-btn').addEventListener('click', () => {
                document.getElementById('sidebar-left').classList.toggle('open');
                document.getElementById('sidebar-right').classList.toggle('open');
            });

            // New UI Toggle
            document.getElementById('toggle-ui-btn').addEventListener('click', toggleUiVisibility);
        }

        // ----- CORE INTERACTIONS -----

        async function onCompanySelect(index) {
            currentCompanyIndex = index;
            const company = companyData[index];
            if (!company) return;

            currentChartIndex = 0; // Reset to stock chart on new company select

            // 1. Update bottom panel
            document.getElementById('company-info-header').innerText = `${company.Name} (${company.Symbol})`;
            document.getElementById('bottom-panel').classList.add('open');

            // 2. Update charts - NOW WITH LIVE DATA FALLBACK
            await updateCharts(company);

            // 3. Highlight and fly to map markers
            if (companyMarkers[company.Symbol]) {
                const group = L.featureGroup(companyMarkers[company.Symbol]);
                map.flyToBounds(group.getBounds().pad(0.5), { duration: 1.0 });

                // Highlight selected markers
                Object.keys(companyMarkers).forEach(symbol => {
                    companyMarkers[symbol].forEach(marker => {
                        // Reset style/highlight for ALL markers first
                        const primary = marker.feature.properties.primaryCommodity;
                        const color = commodityColors[primary] || commodityColors['default'];
                        marker.setStyle({
                            radius: 6,
                            color: color,
                            weight: 1
                        });
                        marker.getElement().classList.remove('glowing-marker');
                    });
                });

                // Apply highlight to SELECTED markers
                companyMarkers[company.Symbol].forEach(marker => {
                    marker.setStyle({ radius: 6, weight: 2 });
                    marker.getElement().classList.add('glowing-marker');
                });
            }

            // 4. Close sidebars on mobile if they are open
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar-left').classList.remove('open');
                document.getElementById('sidebar-right').classList.remove('open');
            }
        }

        function toggleUiVisibility() {
            isUiHidden = !isUiHidden;

            // Toggle panels
            document.getElementById('sidebar-left').classList.toggle('ui-hidden', isUiHidden);
            document.getElementById('sidebar-right').classList.toggle('ui-hidden', isUiHidden);
            document.getElementById('bottom-panel').classList.toggle('ui-hidden', isUiHidden);

            // Hide mobile button as well
            document.getElementById('mobile-toggle-btn').classList.toggle('ui-hidden', isUiHidden);

            // Toggle icons
            document.getElementById('icon-hide').classList.toggle('hidden', isUiHidden);
            document.getElementById('icon-show').classList.toggle('hidden', !isUiHidden);
        }

        async function selectNextCompany() {
            if (currentCompanyIndex === -1) return; // No company selected yet
            const nextIndex = (currentCompanyIndex + 1) % companyData.length;
            await onCompanySelect(nextIndex); // Now async
        }

        async function selectPreviousCompany() {
            if (currentCompanyIndex === -1) return; // No company selected yet
            const prevIndex = (currentCompanyIndex - 1 + companyData.length) % companyData.length;
            await onCompanySelect(prevIndex); // Now async
        }

        // New functions to cycle charts
        async function selectNextChart() {
            if (currentCompanyIndex === -1) return; // No company selected
            currentChartIndex = (currentChartIndex + 1) % chartTitles.length;
            await updateCharts(companyData[currentCompanyIndex]);
        }

        async function selectPreviousChart() {
            if (currentCompanyIndex === -1) return; // No company selected
            currentChartIndex = (currentChartIndex - 1 + chartTitles.length) % chartTitles.length;
            await updateCharts(companyData[currentCompanyIndex]);
        }


        // ----- CHARTING -----

        /**
         * Fetches REAL stock data from Alpha Vantage.
         */
        async function fetchRealStockData(symbol) {
            // Handle symbols with exchange suffixes (e.g., "601088.SS" -> "601088.SHA")
            let apiSymbol = symbol;
            if (symbol.endsWith('.SS')) {
                apiSymbol = symbol.replace('.SS', '.SHA'); // Shanghai
            } else if (symbol.endsWith('.L')) {
                apiSymbol = symbol.replace('.L', '.LON'); // London
            } else if (symbol.endsWith('.AX')) {
                apiSymbol = symbol.replace('.AX', '.AUS'); // Australia
            } else if (symbol.endsWith('.TO')) {
                apiSymbol = symbol.replace('.TO', '.TRT'); // Toronto
            } else if (symbol.endsWith('.JK')) {
                apiSymbol = symbol.replace('.JK', '.JAK'); // Jakarta
            } else if (symbol.endsWith('.NS')) {
                apiSymbol = symbol.replace('.NS', '.BOM'); // Bombay
            } else if (symbol.endsWith('.ME')) {
                apiSymbol = symbol.replace('.ME', '.MCX'); // Moscow
            } else if (symbol.endsWith('.SZ')) {
                apiSymbol = symbol.replace('.SZ', '.SHE'); // Shenzhen
            } else if (symbol.endsWith('.SR')) {
                apiSymbol = symbol.replace('.SR', '.SAU'); // Saudi
            } else if (symbol.endsWith('.HK')) {
                apiSymbol = symbol.replace('.HK', '.HKG'); // Hong Kong
            } else if (symbol.endsWith('.HE')) {
                apiSymbol = symbol.replace('.HE', '.HEL'); // Helsinki
            }
            // .V, .F, .MX are often problematic or require different handling, but we try

            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_MONTHLY_ADJUSTED&symbol=${apiSymbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data["Note"] || data["Error Message"]) {
                throw new Error(data["Note"] || data["Error Message"]);
            }

            const timeSeriesData = data["Monthly Adjusted Time Series"];
            if (!timeSeriesData) {
                throw new Error('Invalid API response structure or symbol not found.');
            }

            const allLabels = Object.keys(timeSeriesData).reverse(); // Oldest first
            const allPriceData = allLabels.map(label => parseFloat(timeSeriesData[label]["5. adjusted close"]));

            // Filter for 2005-2025
            const labels = [];
            const priceData = [];
            for (let i = 0; i < allLabels.length; i++) {
                if (allLabels[i] >= '2005-01-01' && allLabels[i] <= '2025-12-31') {
                    labels.push(allLabels[i].slice(0, 7)); // 'YYYY-MM' format
                    priceData.push(allPriceData[i]);
                }
            }

            return { labels, priceData };
        }
        /**
         * Generates fake monthly rainfall data for a given symbol over the 2005-2025 period.
         * Used as a backup for companies without real rain data (all except BHP and CCJ).
         */
        function generateFakeRainData(symbol, refLabels) {
            const labels = refLabels;
            const rainData = [];
            let maxRain = 0;

            // Generate data points corresponding to the refLabels
            labels.forEach(label => {
                const year = parseInt(label.substring(0, 4));
                const month = parseInt(label.substring(5, 7));

                // Use a simple sine wave to simulate seasonality (higher in summer months 6-8)
                const date = new Date(year, month - 1, 1);
                let base = (Math.sin((date.getMonth() / 12) * 2 * Math.PI) + 1.5) * 5;

                // Add randomness based on the month and company symbol (for slight variation)
                let randomFactor = (Math.random() * 5);
                if (symbol.length > 3) randomFactor += symbol.charCodeAt(0) % 5;

                let discharge = parseFloat((base + randomFactor).toFixed(2));

                // Keep peak low unless it's BHP/CCJ to ensure they stand out
                if (discharge > 15) discharge = 15 + Math.random() * 5;

                if (discharge > maxRain) {
                    maxRain = discharge;
                }
                rainData.push(discharge);
            });

            return { labels: labels, data: rainData, maxData: maxRain };
        }

        /**
         * Fetches REAL Income Statement data (annual) from Alpha Vantage.
         */
        async function fetchIncomeStatement(symbol) {
            let apiSymbol = symbol;
            // (Symbol conversion logic - same as fetchRealStockData)
            if (symbol.endsWith('.SS')) { apiSymbol = symbol.replace('.SS', '.SHA'); }
            else if (symbol.endsWith('.L')) { apiSymbol = symbol.replace('.L', '.LON'); }
            else if (symbol.endsWith('.AX')) { apiSymbol = symbol.replace('.AX', '.AUS'); }
            else if (symbol.endsWith('.TO')) { apiSymbol = symbol.replace('.TO', '.TRT'); }
            else if (symbol.endsWith('.JK')) { apiSymbol = symbol.replace('.JK', '.JAK'); }
            else if (symbol.endsWith('.NS')) { apiSymbol = symbol.replace('.NS', '.BOM'); }
            else if (symbol.endsWith('.ME')) { apiSymbol = symbol.replace('.ME', '.MCX'); }
            else if (symbol.endsWith('.SZ')) { apiSymbol = symbol.replace('.SZ', '.SHE'); }
            else if (symbol.endsWith('.SR')) { apiSymbol = symbol.replace('.SR', '.SAU'); }
            else if (symbol.endsWith('.HK')) { apiSymbol = symbol.replace('.HK', '.HKG'); }
            else if (symbol.endsWith('.HE')) { apiSymbol = symbol.replace('.HE', '.HEL'); }

            const url = `https://www.alphavantage.co/query?function=INCOME_STATEMENT&symbol=${apiSymbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data["Note"] || data["Error Message"]) throw new Error(data["Note"] || data["Error Message"]);
            if (!data.annualReports) throw new Error('Invalid API response for Income Statement.');
            return data.annualReports;
        }

        /**
         * Fetches REAL Balance Sheet data (annual) from Alpha Vantage.
         */
        async function fetchBalanceSheet(symbol) {
            let apiSymbol = symbol;
            // (Symbol conversion logic - same as fetchRealStockData)
            if (symbol.endsWith('.SS')) { apiSymbol = symbol.replace('.SS', '.SHA'); }
            else if (symbol.endsWith('.L')) { apiSymbol = symbol.replace('.L', '.LON'); }
            else if (symbol.endsWith('.AX')) { apiSymbol = symbol.replace('.AX', '.AUS'); }
            else if (symbol.endsWith('.TO')) { apiSymbol = symbol.replace('.TO', '.TRT'); }
            else if (symbol.endsWith('.JK')) { apiSymbol = symbol.replace('.JK', '.JAK'); }
            else if (symbol.endsWith('.NS')) { apiSymbol = symbol.replace('.NS', '.BOM'); }
            else if (symbol.endsWith('.ME')) { apiSymbol = symbol.replace('.ME', '.MCX'); }
            else if (symbol.endsWith('.SZ')) { apiSymbol = symbol.replace('.SZ', '.SHE'); }
            else if (symbol.endsWith('.SR')) { apiSymbol = symbol.replace('.SR', '.SAU'); }
            else if (symbol.endsWith('.HK')) { apiSymbol = symbol.replace('.HK', '.HKG'); }
            else if (symbol.endsWith('.HE')) { apiSymbol = symbol.replace('.HE', '.HEL'); }

            const url = `https://www.alphavantage.co/query?function=BALANCE_SHEET&symbol=${apiSymbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data["Note"] || data["Error Message"]) throw new Error(data["Note"] || data["Error Message"]);
            if (!data.annualReports) throw new Error('Invalid API response for Balance Sheet.');
            return data.annualReports;
        }

        function showChartLoading(isLoading) {
            document.getElementById('chart-loader').style.display = isLoading ? 'flex' : 'none';
            document.getElementById('stock-chart').style.opacity = isLoading ? '0.2' : '1';
            document.getElementById('financials-chart').style.opacity = isLoading ? '0.2' : '1';
        }

        async function updateCharts(company) {
            if (!company) return;

            const stockCanvas = document.getElementById('stock-chart');
            const financialsCanvas = document.getElementById('financials-chart');
            const chartTitleEl = document.getElementById('chart-title');

            // Update title
            chartTitleEl.innerText = chartTitles[currentChartIndex];

            if (currentChartIndex === 0) {
                // Show Stock Chart (Stock + Rain for BHP/CCJ)
                stockCanvas.style.display = 'block';
                financialsCanvas.style.display = 'none';

                // --- FETCH LIVE DATA EVERY TIME ---
                let realStockData = null;
                try {
                    showChartLoading(true);
                    realStockData = await fetchRealStockData(company.Symbol);
                } catch (error) {
                    console.warn(`Live API call failed for ${company.Symbol}. Using mock data. Error:`, error.message);
                } finally {
                    showChartLoading(false);
                    drawStockChart(company, realStockData); // Pass real data (or null) to chart renderer
                }
                // --- END FETCH ---

            } else {
                // Show Financials Chart (or Market Forecast placeholder)
                stockCanvas.style.display = 'none';
                financialsCanvas.style.display = 'block';

                if (currentChartIndex === 1) {
                    // Market Forecast (Using Financials chart container for mock display)
                    drawMarketForecastChart(company);
                } else if (currentChartIndex === 2) {
                    // Actual Financials
                    // --- FETCH LIVE FINANCIAL DATA (with cache) ---
                    let realFinancialsData = null;
                    try {
                        showChartLoading(true);
                        if (financialsCache[company.Symbol]) {
                            console.log(`Using cached financial data for ${company.Symbol}`);
                            realFinancialsData = financialsCache[company.Symbol];
                        } else {
                            console.log(`Fetching new financial data for ${company.Symbol}`);
                            const [income, balance] = await Promise.all([
                                fetchIncomeStatement(company.Symbol),
                                fetchBalanceSheet(company.Symbol)
                            ]);
                            realFinancialsData = { income, balance };
                            financialsCache[company.Symbol] = realFinancialsData; // Save to cache
                        }
                    } catch (error) {
                        console.warn(`Live financial API call failed for ${company.Symbol}. Using mock data. Error:`, error.message);
                    } finally {
                        showChartLoading(false);
                        drawFinancialsChart(company, realFinancialsData);
                    }
                    // --- END FETCH ---
                }
            }
        }

        // ----- NEW HELPER FUNCTION: Parse Daily to Monthly Close Price -----
        // Used exclusively by drawMarketForecastChart for BHP's historical CSV data.
        function parseDailyToMonthlyClose(csvString, start, end) {
            const parsed = Papa.parse(csvString.trim(), { header: true, skipEmptyLines: true });
            const monthlyData = {};

            // Find the relevant column names (Date and Close)
            const dateCol = parsed.meta.fields.find(f => /date/i.test(f) || /Snapshot/i.test(f) || /day/i.test(f));
            const closeCol = parsed.meta.fields.find(f => /Close/i.test(f));

            if (!dateCol || !closeCol) {
                console.error("CSV must contain columns named 'Date' and 'Close'.");
                return { labels: [], data: [] };
            }

            parsed.data.forEach(row => {
                const dateStr = row[dateCol];
                const closePrice = parseFloat(row[closeCol]);

                if (dateStr && !isNaN(closePrice)) {
                    const monthKey = dateStr.slice(0, 7); // 'YYYY-MM'

                    // Only process data within the target range (Jan 2021 to Sep 2025)
                    if (monthKey.localeCompare(start) >= 0 && monthKey.localeCompare(end) <= 0) {
                        // Keep track of the *last* date's closing price for each month.
                        if (!monthlyData[monthKey] || dateStr > monthlyData[monthKey].date) {
                            monthlyData[monthKey] = {
                                date: dateStr,
                                price: closePrice
                            };
                        }
                    }
                }
            });

            // Convert the map into sorted arrays
            const labels = Object.keys(monthlyData).sort();
            const data = labels.map(key => monthlyData[key].price);

            return { labels: labels, data: data };
        }
        // ----- END NEW HELPER FUNCTION -----  // ----- NEW HELPER FUNCTION: Parse Daily to Monthly Close Price -----
        // Used exclusively by drawMarketForecastChart for BHP's historical CSV data.
        function parseDailyToMonthlyClose(csvString, start, end) {
            const parsed = Papa.parse(csvString.trim(), { header: true, skipEmptyLines: true });
            const monthlyData = {};

            // Find the relevant column names (Date and Close)
            const dateCol = parsed.meta.fields.find(f => /date/i.test(f) || /Snapshot/i.test(f) || /day/i.test(f));
            const closeCol = parsed.meta.fields.find(f => /Close/i.test(f));

            if (!dateCol || !closeCol) {
                console.error("CSV must contain columns named 'Date' and 'Close'.");
                return { labels: [], data: [] };
            }

            parsed.data.forEach(row => {
                const dateStr = row[dateCol];
                const closePrice = parseFloat(row[closeCol]);

                if (dateStr && !isNaN(closePrice)) {
                    const monthKey = dateStr.slice(0, 7); // 'YYYY-MM'

                    // Only process data within the target range (Jan 2021 to Sep 2025)
                    if (monthKey.localeCompare(start) >= 0 && monthKey.localeCompare(end) <= 0) {
                        // Keep track of the *last* date's closing price for each month.
                        if (!monthlyData[monthKey] || dateStr > monthlyData[monthKey].date) {
                            monthlyData[monthKey] = {
                                date: dateStr,
                                price: closePrice
                            };
                        }
                    }
                }
            });

            // Convert the map into sorted arrays
            const labels = Object.keys(monthlyData).sort();
            const data = labels.map(key => monthlyData[key].price);

            return { labels: labels, data: data };
        }
        // ----- END NEW HELPER FUNCTION -----

        // MODIFIED: drawMarketForecastChart now handles BHP's specific historical + forecast data
        function drawMarketForecastChart(company) {
            const ctx = document.getElementById('financials-chart').getContext('2d');
            if (charts.financials) charts.financials.destroy();

            // --- SPECIAL LOGIC: BHP Forecast (Historical + Forecast Stock Price + Rainfall) ---
            if (company.Symbol === 'BHP') {
                const START_DATE_HIST = '2021-01';
                const END_DATE_HIST = '2025-09';

                // 1. Process Historical Data (from simulated CSV)
                const historicalData = [
                    ['Jan 2021', 61.93],
                    ['Feb 2021', 70.4],
                    ['Mar 2021', 64.35],
                    ['Apr 2021', 67.48],
                    ['May 2021', 68.73],
                    ['Jun 2021', 67.54],
                    ['Jul 2021', 72.85],
                    ['Aug 2021', 61.34],
                    ['Sept 2021', 49.63],
                    ['Oct 2021', 50.86],
                    ['Nov 2021', 52.11],
                    ['Dec 2021', 55.97],
                    ['Jan 2022', 58.98],
                    ['Feb 2022', 62.87],
                    ['Mar 2022', 71.64],
                    ['Apr 2022', 62.12],
                    ['May 2022', 65.53],
                    ['Jun 2022', 56.18],
                    ['Jul 2022', 55.04],
                    ['Aug 2022', 54.89],
                    ['Sept 2022', 50.04],
                    ['Oct 2022', 47.82],
                    ['Nov 2022', 62.8],
                    ['Dec 2022', 62.05],
                    ['Jan 2023', 70.15],
                    ['Feb 2023', 60.97],
                    ['Mar 2023', 63.41],
                    ['Apr 2023', 59.04],
                    ['May 2023', 54.9],
                    ['Jun 2023', 59.67],
                    ['Jul 2023', 62.65],
                    ['Aug 2023', 57.49],
                    ['Sept 2023', 56.88],
                    ['Oct 2023', 57.06],
                    ['Nov 2023', 60.96],
                    ['Dec 2023', 68.31],
                    ['Jan 2024', 61.22],
                    ['Feb 2024', 57.34],
                    ['Mar 2024', 57.69],
                    ['Apr 2024', 55.16],
                    ['May 2024', 59.53],
                    ['Jun 2024', 57.09],
                    ['Jul 2024', 55.53],
                    ['Aug 2024', 55.13],
                    ['Sept 2024', 62.11],
                    ['Oct 2024', 55.46],
                    ['Nov 2024', 52.65],
                    ['Dec 2024', 48.83],
                    ['Jan 2025', 49.15],
                    ['Feb 2025', 48.48],
                    ['Mar 2025', 48.54],
                    ['Apr 2025', 47.55],
                    ['May 2025', 48.99],
                    ['Jun 2025', 48.09],
                    ['Jul 2025', 50.67],
                    ['Aug 2025', 55.77],
                    ['Sept 2025', 55.75],
                    ['Oct 2025', 55.62]
                ];
                const historicalLabels = [];
                const historicalPriceData = [];

                // 2. Prepare Forecast Data
                const bhpForecastRawData = [
                    ['Nov 2025', 56.2, 0.00], ['Dec 2025', 56.9, 0.00], ['Jan 2026', 57.4, 0.00], ['Feb 2026', 57.4, 0.00],
                    ['Mar 2026', 59.7, 0.00], ['Apr 2026', 59.1, 0.01], ['May 2026', 60, 0.02], ['Jun 2026', 62.1, 0.00],
                    ['Jul 2026', 61.8, 0.00], ['Aug 2026', 62.7, 0.00], ['Sept 2026', 61.3, 0.00], ['Oct 2026', 58.1, 0.00],
                    ['Nov 2026', 59.2, 0.00], ['Dec 2026', 58.3, 0.00], ['Jan 2027', 59.3, 0.00], ['Feb 2027', 62.1, 0.01],
                    ['Mar 2027', 63.5, 0.01], ['Apr 2027', 65.1, 0.01], ['May 2027', 64.8, 0.00], ['Jun 2027', 64.2, 0.00],
                    ['Jul 2027', 67, 0.01], ['Aug 2027', 68.1, 0.00], ['Sept 2027', 69.5, 0.00], ['Oct 2027', 69.8, 0.00],
                    ['Nov 2027', 66.7, 0.00],
                    ['Dec 2027', 67.5, 0.00] // Added Dec 2027 to ensure full range to Dec 2027
                ];

                let forecastLabels = [];
                let forecastPriceData = [];
                let forecastRainData = [];
                const monthMap = { 'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08', 'Sept': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12' };

                bhpForecastRawData.forEach(item => {
                    const [monthStr, yearStr] = item[0].split(' ');
                    forecastLabels.push(`${yearStr}-${monthMap[monthStr]}`);
                    forecastPriceData.push(item[1]);
                    forecastRainData.push(item[2]);
                });

                historicalData.forEach(item => {
                    const [monthStr, yearStr] = item[0].split(' ');
                    historicalLabels.push(`${yearStr}-${monthMap[monthStr]}`);
                    historicalPriceData.push(item[1]);
                });

                // 3. Combine Data (Historical + Gap + Forecast)
                let allLabels = [...historicalLabels];

                // Data arrays for datasets
                let historicalStockDataset = [...historicalPriceData];
                let forecastStockDataset = Array(historicalLabels.length).fill(null);
                let allRainDataset = Array(historicalLabels.length).fill(null);

                // // Handle the **October 2025 gap**
                // const lastHistMonth = historicalLabels.length > 0 ? historicalLabels[historicalLabels.length - 1] : '2020-12';
                // if (lastHistMonth.localeCompare('2025-09') === 0) {
                //     allLabels.push('2025-10');
                //     historicalStockDataset.push(null);
                //     forecastStockDataset.push(null);
                //     allRainDataset.push(null);
                // }

                // Append forecast data
                allLabels = allLabels.concat(forecastLabels);
                historicalStockDataset = historicalStockDataset.concat(Array(forecastPriceData.length).fill(null));
                forecastStockDataset = forecastStockDataset.concat(forecastPriceData);
                allRainDataset = allRainDataset.concat(forecastRainData);

                // Calculate max values for axes
                const maxPrice = Math.max(...historicalPriceData, ...forecastPriceData) * 1.05;
                const maxRain = Math.max(...forecastRainData) * 1.5;

                const datasets = [
                    // Historical Stock Price (Solid Green)
                    {
                        label: 'Stock Price (Historical)',
                        data: historicalStockDataset,
                        borderColor: '#39FF14', // Neon Green
                        backgroundColor: 'rgba(57, 255, 20, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        yAxisID: 'y-price',
                        borderWidth: 2,
                        spanGaps: true,
                        order: 3 // On top of everything
                    },
                    // Forecast Stock Price (Dashed Red with Dots)
                    {
                        label: 'BNP Stock Price Forecast',
                        data: forecastStockDataset,
                        borderColor: '#FF073A', // Neon Red/Pink
                        backgroundColor: 'transparent',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 3, // Dots
                        borderWidth: 2,
                        borderDash: [5, 5], // Dashed line
                        yAxisID: 'y-price',
                        spanGaps: true,
                        order: 4 // On top of historical
                    },
                    // Rainfall Forecast (Bar, Cyan)
                    {
                        type: 'line',
                        label: 'Rainfall Forecast (m³/s)',
                        data: allRainDataset,
                        borderColor: '#00E5FF', // Neon Red/Pink
                        backgroundColor: '#00E5FF', // Semi-transparent Cyan
                        yAxisID: 'y-rain',
                        order: 1 // Behind price lines
                    }
                ];

                const chartConfig = {
                    type: 'line',
                    data: { labels: allLabels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            'y-price': {
                                type: 'linear',
                                position: 'left',
                                beginAtZero: false,
                                max: maxPrice,
                                ticks: { color: '#9CA3AF' },
                                grid: { color: 'rgba(55, 65, 81, 0.5)' },
                                title: { display: true, text: 'Price (USD)', color: '#9CA3AF' }
                            },
                            'y-rain': {
                                type: 'linear',
                                position: 'right',
                                beginAtZero: true,
                                max: maxRain,
                                ticks: { color: '#00E5FF' },
                                grid: { display: false },
                                title: { display: true, text: 'Rainfall (m³/s)', color: '#00E5FF' }
                            },
                            x: {
                                ticks: { color: '#9CA3AF' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#D1D5DB' } },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (context.parsed.y !== null) {
                                            if (context.dataset.yAxisID === 'y-price') {
                                                label += `: $${context.parsed.y.toFixed(2)}`;
                                            } else {
                                                label += `: ${context.parsed.y.toFixed(2)} m³/s`;
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                };

                charts.financials = new Chart(ctx, chartConfig);
                return;
            }

            // --- DEFAULT LOGIC (Market Cap Forecast for other companies) ---

            // This section remains UNIMPACTED, ensuring other companies' forecasts work as before.
            const mockCompany = companyData.find(c => c.Symbol === company.Symbol);
            const labels = ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025'];
            let baseMarketCap = 50;
            if (MOCK_FINANCIAL_DATA[mockCompany.Symbol] && MOCK_FINANCIAL_DATA[mockCompany.Symbol].length > 0) {
                baseMarketCap = parseFloat(MOCK_FINANCIAL_DATA[mockCompany.Symbol][MOCK_FINANCIAL_DATA[mockCompany.Symbol].length - 1].marketcap) / 1000;
            }

            const mockForecast = labels.map((_, i) => baseMarketCap * (1 + Math.random() * 0.05 + (i * 0.01)));

            charts.financials = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Market Cap Forecast (Billion USD)',
                        data: mockForecast,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#FFD700',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(55, 65, 81, 0.5)' } },
                        y: { beginAtZero: false, ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(55, 65, 81, 0.5)' }, title: { display: true, text: 'Billion USD', color: '#9CA3AF' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#D1D5DB' } },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }
        // Placeholder for Market Forecast - using financial chart canvas
        const ctx = document.getElementById('financials-chart').getContext('2d');
        if (charts.financials) charts.financials.destroy();

        // Simple data for the mockup
        const labels = ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025'];
        const mockForecast = labels.map((_, i) => parseFloat(company.marketcap) / 1e9 * (1 + Math.random() * 0.05 + (i * 0.01))); // increasing forecast

        charts.financials = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Market Cap Forecast (Billion USD)',
                    data: mockForecast,
                    borderColor: '#FFD700', // Gold color for forecast
                    backgroundColor: 'rgba(255, 215, 0, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#FFD700',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(55, 65, 81, 0.5)' }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { color: '#9CA3AF' },
                        grid: { color: 'rgba(55, 65, 81, 0.5)' },
                        title: {
                            display: true,
                            text: 'Billion USD',
                            color: '#9CA3AF'
                        }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#D1D5DB' } },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });



        function drawStockChart(company, realStockData) {
            const companyFinancials = MOCK_FINANCIAL_DATA[company.Symbol];

            if (!companyFinancials) {
                console.warn(`No financial data found for ${company.Symbol}`);
                return;
            }

            const stockCtx = document.getElementById('stock-chart').getContext('2d');

            let labels, priceData, sourceLabel;

            // Check if we have VALID real data
            if (realStockData && realStockData.labels && realStockData.labels.length > 0) {
                labels = realStockData.labels;
                priceData = realStockData.priceData;
                sourceLabel = 'Stock Price (Live) 2005-2025';
                console.log(`Displaying LIVE data for ${company.Symbol}`);
            } else {
                // Fallback to mock data
                labels = companyFinancials.map(d => d.date).slice(0, 240);
                priceData = companyFinancials.map(d => d.price).slice(0, 240);
                sourceLabel = 'Stock Price (Mock) 2005-2025';
                if (realStockData) { // This means the API call was made but returned empty
                    console.warn(`Live data for ${company.Symbol} was empty. Using mock data.`);
                }
            }

            // --- 1. Base Stock Data Series ---
            const datasets = [{
                label: sourceLabel,
                data: priceData,
                borderColor: '#39FF14', // Neon Green (Requested: opposite of old Cyan/Blue)
                backgroundColor: 'rgba(57, 255, 20, 0.1)', // Neon Green tint
                fill: true,
                tension: 0.1,
                pointRadius: 0,
                yAxisID: 'y' // Primary Y-axis for Price
            }];

            // --- 2. Rain Data Series (if applicable) ---
            // Determine if the company has hardcoded rain data (BHP or CCJ)
            const rainDataKey = company.Symbol === ' ' ? ' ' : (company.Symbol === ' ' ? ' ' : null);

            let finalRainData = null;

            if (rainDataKey) {
                // Determine which raw CSV string to pass to the processing function
                // FIX: Use the correct variable names imported from data.js (bhp_rain, cameco_rain)
                const rawCsv = rainDataKey === 'BHP' ? bhp_rain : cameco_rain;

                // Call the parsing function with the raw CSV data
                const rainChartData = parseDailyToMonthlyMean(rawCsv);

                // If data parsing yielded results, use it (handles null return from parseDailyToMonthlyMean)
                if (rainChartData) {
                    finalRainData = rainChartData;
                }
            } else if (company.Symbol !== 'METSO.HE') {
                // Fallback: Use Fake Rain Data for all other companies (excluding Metso)
                finalRainData = generateFakeRainData(company.Symbol, labels);
            }

            // --- 3. Integrate Rain Data into Datasets and Axes ---
            // Initialize the axis configuration for the Chart.js options structure
            const axisConfig = {
                y: {
                    beginAtZero: false,
                    position: 'left',
                    ticks: { color: '#9CA3AF' },
                    grid: { color: 'rgba(55, 65, 81, 0.5)' },
                    title: {
                        display: true,
                        text: 'Price (USD)',
                        color: '#9CA3AF'
                    }
                }
            };

            if (finalRainData && finalRainData.data && finalRainData.data.length > 0) {
                const rainData = finalRainData;

                // Align rain data points to the main stock chart labels.
                const alignedRainData = labels.map(dateLabel => {
                    // All stock labels must be standardized to 'YYYY-MM' for lookup.
                    const monthLabel = dateLabel.substring(0, 7);
                    const index = rainData.labels.indexOf(monthLabel);

                    // If the monthly rain data exists, return the value; otherwise, null for gap.
                    return index > -1 ? rainData.data[index] : null;
                });

                // Add Rain dataset (River Discharge)
                datasets.push({
                    type: 'line',
                    label: 'Mean River Discharge (m³/s)',
                    data: alignedRainData,
                    borderColor: '#00E5FF', // Neon Cyan
                    backgroundColor: 'rgba(0, 229, 255, 0.1)', // Light fill
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    yAxisID: 'y1', // Secondary Y-axis for Rain
                    order: 1 // Draw the rain line behind the stock line
                });

                // Add secondary Y-axis configuration
                axisConfig.y1 = {
                    beginAtZero: true,
                    position: 'right',
                    ticks: { color: '#00E5FF' },
                    grid: {
                        display: true,
                        drawOnChartArea: false, // Hide vertical lines but show tick marks
                        color: 'rgba(0, 229, 255, 0.2)'
                    },
                    title: {
                        display: true,
                        text: 'River Discharge (m³/s)',
                        color: '#00E5FF'
                    },
                    // Use the dynamically calculated maxData for appropriate scaling.
                    max: rainData.maxData > 0 ? rainData.maxData * 1.2 : 15,
                    min: 0
                };
            }

            if (finalRainData && finalRainData.data && finalRainData.data.length > 0) {
                const rainData = finalRainData;

                // Align rain data points to the main stock chart labels.
                const alignedRainData = labels.map(dateLabel => {
                    // All stock labels must be standardized to 'YYYY-MM' for lookup.
                    const monthLabel = dateLabel.substring(0, 7);
                    const index = rainData.labels.indexOf(monthLabel);

                    // If the monthly rain data exists, return the value; otherwise, null for gap.
                    return index > -1 ? rainData.data[index] : null;
                });

                // Add Rain dataset (River Discharge)
                datasets.push({
                    type: 'line',
                    label: 'Mean River Discharge (m³/s)',
                    data: alignedRainData,
                    borderColor: '#00E5FF', // Neon Cyan
                    backgroundColor: 'rgba(0, 229, 255, 0.1)', // Light fill
                    fill: true,
                    tension: 0.2,
                    pointRadius: 0,
                    yAxisID: 'y1', // Secondary Y-axis for Rain
                    order: 1 // Draw the rain line behind the stock line
                });

                // Add secondary Y-axis configuration
                axisConfig.y1 = {
                    beginAtZero: true,
                    position: 'right',
                    ticks: { color: '#00E5FF' },
                    grid: {
                        display: true,
                        drawOnChartArea: false, // Hide vertical lines but show tick marks
                        color: 'rgba(0, 229, 255, 0.2)'
                    },
                    title: {
                        display: true,
                        text: 'River Discharge (m³/s)',
                        color: '#00E5FF'
                    },
                    // Use the dynamically calculated maxData for appropriate scaling.
                    max: rainData.maxData > 0 ? rainData.maxData * 1.2 : 15,
                    min: 0
                };
            }

            // Define the chart configuration
            const chartConfig = {
                type: 'line', // Base type is line
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            stacked: false,
                            ticks: { color: '#9CA3AF' },
                            grid: { display: false }
                        },
                        ...axisConfig // Merge the axis configurations
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#D1D5DB',
                                boxWidth: 10,
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                // Add m³/s unit to rainfall tooltip
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                        // Check if this dataset uses the secondary axis (y1)
                                        if (context.dataset.yAxisID === 'y1') {
                                            label += ' m³/s';
                                        } else {
                                            label += ' USD';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };

            // Destroy existing chart instance to prevent memory leaks and redraw
            if (charts.stock) {
                charts.stock.destroy();
            }

            // Create the new chart
            charts.stock = new Chart(stockCtx, chartConfig);
        }

        function drawFinancialsChart(company, realFinancialsData = null) {
            const companyFinancials = MOCK_FINANCIAL_DATA[company.Symbol];
            if (!companyFinancials) {
                console.warn(`No financial data found for ${company.Symbol}`);
                return;
            }

            const financialsCtx = document.getElementById('financials-chart').getContext('2d');

            let annualLabels, revenueData, earningsData, debtData, sourceLabel;

            // Try to parse real data first
            try {
                if (realFinancialsData && realFinancialsData.income && realFinancialsData.balance) {
                    console.log(`Displaying LIVE financial data for ${company.Symbol}`);
                    const dataMap = {};

                    // Process Income Statement (newest first)
                    realFinancialsData.income.forEach(report => {
                        const year = report.fiscalDateEnding.slice(0, 4);
                        dataMap[year] = {
                            revenue: parseFloat(report.totalRevenue),
                            earnings: parseFloat(report.netIncome)
                        };
                    });

                    // Process Balance Sheet (newest first)
                    realFinancialsData.balance.forEach(report => {
                        const year = report.fiscalDateEnding.slice(0, 4);
                        if (dataMap[year]) {
                            // Use totalDebt if available, otherwise longTermDebt, otherwise 0
                            const debt = parseFloat(report.totalDebt) || parseFloat(report.longTermDebt) || 0;
                            dataMap[year].debt = debt;
                        }
                    });

                    // Filter for 2021-2030 and sort ascending
                    const sortedYears = Object.keys(dataMap)
                        .filter(year => parseInt(year) >= 2021 && parseInt(year) <= 2030)
                        .sort();

                    if (sortedYears.length === 0) throw new Error("No matching annual data found in live feed.");

                    annualLabels = sortedYears;
                    revenueData = sortedYears.map(year => dataMap[year].revenue / 1e9); // in Billions
                    earningsData = sortedYears.map(year => dataMap[year].earnings / 1e9); // in Billions
                    debtData = sortedYears.map(year => (dataMap[year].debt || 0) / 1e9); // in Billions
                    sourceLabel = ' (Live)';
                } else {
                    throw new Error('Real data is null or incomplete, using mock data.');
                }
            } catch (error) {
                // Fallback to mock data
                console.warn(error.message);
                const annualData = companyFinancials.filter(d => d.date.endsWith('-12')); // Get Dec data for each year
                const filteredData = annualData.filter(d => {
                    const year = parseInt(d.date.slice(0, 4));
                    return year >= 2021 && year <= 2030;
                });

                annualLabels = filteredData.map(d => d.date.slice(0, 4));
                revenueData = filteredData.map(d => d.revenue / 1e3); // in Billions
                earningsData = filteredData.map(d => d.earnings / 1e3); // in Billions
                debtData = filteredData.map(d => d.debt / 1e3); // in Billions
                sourceLabel = ' (Mock)';
            }


            // Define colors for past and future (2025+)
            const pastColorRevenue = '#39FF14'; // Neon Green
            const futureColorRevenue = '#AFFF9A'; // Light Neon Green
            const pastColorEarnings = '#00E5FF'; // Neon Cyan
            const futureColorEarnings = '#9AFBFF'; // Light Neon Cyan
            const pastColorDebt = '#FF073A'; // Neon Pink/Red
            const futureColorDebt = '#FF9AB2'; // Light Neon Pink

            if (charts.financials) charts.financials.destroy();

            charts.financials = new Chart(financialsCtx, {
                type: 'bar',
                data: {
                    labels: annualLabels,
                    datasets: [
                        {
                            label: `Revenue (Billion USD)${sourceLabel}`,
                            data: revenueData,
                            backgroundColor: (context) => {
                                const year = context.chart.data.labels[context.dataIndex];
                                return parseInt(year) >= 2025 ? futureColorRevenue : pastColorRevenue;
                            },
                        },
                        {
                            label: `Earnings (Billion USD)${sourceLabel}`,
                            data: earningsData,
                            backgroundColor: (context) => {
                                const year = context.chart.data.labels[context.dataIndex];
                                return parseInt(year) >= 2025 ? futureColorEarnings : pastColorEarnings;
                            },
                        },
                        {
                            label: `Debt (Billion USD)${sourceLabel}`,
                            data: debtData,
                            backgroundColor: (context) => {
                                const year = context.chart.data.labels[context.dataIndex];
                                return parseInt(year) >= 2025 ? futureColorDebt : pastColorDebt;
                            },
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: { color: '#9CA3AF' },
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: false, // Y-axis will no longer start at 0
                            stacked: false,
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(55, 65, 81, 0.5)' },
                            title: {
                                display: true,
                                text: 'Billion USD',
                                color: '#9CA3AF'
                            }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#D1D5DB' } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }

    </script>
    <!-- CHATBOT UI -->
    <button id="chatbot-toggle"
        class="fixed bottom-4 right-4 bg-green-500 hover:bg-green-400 text-white font-bold py-2 px-4 rounded-full shadow-lg z-[1003]">
        💬
    </button>

    <div id="chatbot-panel"
        class="hidden fixed bottom-20 right-4 w-80 bg-gray-900/90 backdrop-blur-lg border border-gray-700 rounded-2xl p-4 z-[1003] flex flex-col max-h-[70vh]">
        <div id="chat-output" class="flex-1 overflow-y-auto text-gray-200 mb-3 space-y-2"></div>
        <div class="flex">
            <input id="chat-input" type="text" placeholder="Ask QuantOre AI..."
                class="flex-1 rounded-l-lg bg-gray-800 text-white px-3 py-2 outline-none border border-gray-700 focus:border-green-400">
            <button id="chat-send" class="bg-green-500 hover:bg-green-400 text-white rounded-r-lg px-3">Send</button>
        </div>
    </div>

    <script type="module" src="gemini.js"></script>
</body>

</html>