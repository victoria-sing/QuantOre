<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fintech Geo-Risk Analyzer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js (for maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js (for financial charts) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    
    <!-- PapaParse (for CSV parsing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* Base styles */
        html, body {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on the body */
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #111827; /* Dark background */
        }

        /* Map container */
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            background-color: #111827; /* Match body/tile background */
        }

        /* UI Panels */
        .ui-panel {
            position: absolute;
            z-index: 1001;
            background-color: rgba(17, 24, 39, 0.85); /* bg-gray-900 with 85% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(55, 65, 81, 0.5); /* Refined border */
            color: white;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Neon Text Highlight */
        .text-neon-highlight {
            color: #39FF14; /* Neon Green */
            text-shadow: 0 0 4px #39FF14, 0 0 8px #39FF14;
        }

        /* Left and Right Sidebars */
        #sidebar-left, #sidebar-right {
            top: 0;
            height: 100vh;
            width: 22rem; /* w-88 */
            max-width: 90%;
            display: flex;
            flex-direction: column;
        }

        #sidebar-left {
            left: 0;
            border-top-right-radius: 0.75rem; /* rounded-xl */
            border-bottom-right-radius: 0.75rem; /* rounded-xl */
        }

        #sidebar-right {
            right: 0;
            border-top-left-radius: 0.75rem; /* rounded-xl */
            border-bottom-left-radius: 0.75rem; /* rounded-xl */
        }

        /* Hide sidebars on small screens */
        @media (max-width: 1024px) {
            #sidebar-left {
                transform: translateX(-100%);
            }
            #sidebar-right {
                transform: translateX(100%);
            }
            #sidebar-left.open, #sidebar-right.open {
                transform: translateX(0);
            }
        }

        /* Bottom Panel for Charts */
        #bottom-panel {
            bottom: 0;
            width: 100%;
            height: 40%;
            border-top-left-radius: 0.75rem; /* rounded-t-xl */
            border-top-right-radius: 0.75rem; /* rounded-t-xl */
            transform: translateY(100%);
        }

        #bottom-panel.open {
            transform: translateY(0);
        }
        
        /* Chart wrapper to make Chart.js responsive */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 150px; /* Ensure charts are visible */
        }

        /* Custom scrollbar for company list */
        #company-list::-webkit-scrollbar {
            width: 6px;
        }
        #company-list::-webkit-scrollbar-track {
            background: rgba(55, 65, 81, 0.3); /* bg-gray-700 */
            border-radius: 3px;
        }
        #company-list::-webkit-scrollbar-thumb {
            background: #4B5563; /* bg-gray-600 */
            border-radius: 3px;
        }
        #company-list::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* bg-gray-500 */
        }
        
        /* Loading Spinner */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            background: #1F2937; /* bg-gray-800 */
            color: #F3F4F6; /* bg-gray-100 */
            border-radius: 0.5rem;
        }
        .leaflet-popup-content {
            margin: 1rem;
        }
        .leaflet-popup-tip {
            background: #1F2937;
        }
        .leaflet-popup-close-button {
            color: #F3F4F6 !important;
            padding: 4px 4px 0 0 !important;
        }
        
        /* Mobile toggle button */
        #mobile-toggle-btn {
            z-index: 1002;
            position: absolute;
            top: 1rem;
            left: 1rem;
        }
        
        /* Input styles */
        .dark-input {
            background-color: rgba(55, 65, 81, 0.7); /* bg-gray-700 */
            border: 1px solid #4B5563; /* border-gray-600 */
            color: white;
        }
        .dark-input::placeholder {
            color: #9CA3AF; /* text-gray-400 */
        }
        .dark-input:focus {
            outline: none;
            border-color: #39FF14; /* Neon Green */
            box-shadow: 0 0 0 2px rgba(57, 255, 20, 0.5); /* Neon Green glow */
        }
        
        /* Range slider styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4B5563; /* bg-gray-600 */
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #39FF14; /* Neon Green */
            cursor: pointer;
            margin-top: -6px; /* Center thumb */
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4B5563;
            border-radius: 3px;
        }
        input[type=range]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #39FF14; /* Neon Green */
            cursor: pointer;
            border: none;
        }
        
        /* Checkbox styles */
        input[type=checkbox] {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            background-color: rgba(55, 65, 81, 0.7); /* bg-gray-700, matches input */
            border: 1px solid #4B5563; /* border-gray-600, matches input */
            border-radius: 0.25rem;
            cursor: pointer;
            display: inline-block;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
        }
        input[type=checkbox]:checked {
            background-color: #39FF14; /* Neon Green */
            border-color: #39FF14; /* Neon Green */
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='black' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* Removed the ::after rule */

    </style>
</head>
<body class="bg-gray-900">

    <!-- The Map -->
    <div id="map"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <span>Loading Geo-Financial Data...</span>
    </div>

    <!-- Mobile Panel Toggle Button -->
    <button id="mobile-toggle-btn" class="p-2 bg-gray-900/80 backdrop-blur-md text-white rounded-lg lg:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
    </button>
    
    <!-- Left Sidebar (Company List) -->
    <div id="sidebar-left" class="ui-panel p-4">
        <h1 class="text-2xl font-bold mb-4 text-neon-highlight">QuantOre</h1>
        <div class="mb-4">
            <input type="text" id="search-box" placeholder="Search companies..." class="w-full p-2 rounded-lg dark-input">
        </div>
        <!-- Company List Container -->
        <div id="company-list" class="flex-grow overflow-y-auto space-y-1 pr-2">
            <!-- Company items will be injected here by JS -->
        </div>
    </div>

    <!-- Right Sidebar (Layers & Filters) -->
    <div id="sidebar-right" class="ui-panel p-4">
        <h2 class="text-xl font-semibold mb-6 text-neon-highlight">Layers & Analysis</h2>
        
        <!-- Layer Toggles -->
        <div class="space-y-4 mb-8">
            <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="toggle-mines" checked>
                <span class="text-gray-200">Top 50 Mine Sites</span>
            </label>
            <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="toggle-weather">
                <span class="text-gray-200">Global Weather Radar (Sim)</span>
            </label>
            <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="toggle-disasters">
                <span class="text-gray-200">Climate Disaster Risk (Sim)</span>
            </label>
            <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="toggle-targeted-risk">
                <span class="text-gray-200">Targeted Mine Risk (Sim)</span>
            </label>
        </div>

        <!-- Time Slider -->
        <div class="space-y-3">
            <label for="year-slider" class="text-gray-300">Select Year for Risk Analysis</label>
            <input type="range" id="year-slider" min="2025" max="2030" value="2025" step="1" class="w-full">
            <div class="text-center text-xl font-bold text-neon-highlight" id="selected-year">2025</div>
        </div>
    </div>

    <!-- Bottom Panel (Charts & Info) -->
    <div id="bottom-panel" class="ui-panel p-4">
        <!-- Panel Header -->
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-3">
                <button id="prev-company-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 id="company-info-header" class="text-xl font-bold text-neon-highlight">Select a Company</h2>
                <button id="next-company-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <button id="close-panel-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Charts Container -->
        <div id="charts-container" class="h-[calc(100%-4.5rem)]">
            <div class="chart-wrapper">
                <canvas id="stock-chart"></canvas>
                <canvas id="financials-chart" style="display: none;"></canvas>
            </div>
        </div>
        <!-- New Chart Toggle -->
        <div class="flex justify-center items-center gap-4 mt-2">
            <button id="prev-chart-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <span id="chart-title" class="font-semibold text-gray-300 w-32 text-center">Stock Price</span>
            <button id="next-chart-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>


    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // ----- APPLICATION STATE -----
        let map;
        let companyData = [];
        let mineLayer;
        let weatherLayer;
        let disasterLayer;
        let targetedRiskLayer;
        let companyMarkers = {};
        let currentCompanyIndex = -1; // Track the currently selected company
        let currentChartIndex = 0; // 0 = stock, 1 = financials
        const chartTitles = ['Stock Price', 'Financials'];
        const charts = {
            stock: null,
            financials: null
        };

        // ----- USER-UPLOADED CSV DATA -----
        // Content from 'companiesmarketcap.com - Largest mining companies by market cap.csv'
        const csvData = `
"Rank","Name","Symbol","marketcap","price (USD)","country"
"1","BHP Group","BHP","142508982272","55.62","Australia"
"2","China Shenhua Energy","601088.SS","115684445106","5.96818","China"
"3","Rio Tinto","RIO","112893132800","70.54","United Kingdom"
"4","Zijin Mining","601899.SS","110364296070","4.21705","China"
"5","Southern Copper","SCCO","105048522752","129.34","United States"
"6","Newmont","NEM","91577753600","83.37","United States"
"7a","Agnico Eagle Mines","AEM","82057568256","163.35","Canada"
"8","Ma'aden","1211.SR","66440951671","17.12","Saudi Arabia"
"9","Grupo México","GMBXF","63875444736","8.2","Mexico"
"10","Freeport-McMoRan","FCX","59397971968","41.37","United States"
"11","Barrick Gold","B","55410675712","32.61","Canada"
"12","Glencore","GLEN.L","55319803623","5.40536","Switzerland"
"13","Vale","VALE","54269190144","12.42","Brazil"
"14","CMOC","603993.SS","52564243642","2.11584","China"
"15","Wheaton Precious Metals","WPM","49899386880","110.15","Canada"
"16","Fortescue","FMG.AX","46071477141","14.97","Australia"
"17","Anglo American","AAL.L","45591322049","41.16","United Kingdom"
"18","Cameco","CCJ","43003056128","98.77","Canada"
"19","Franco-Nevada","FNV","41029419008","212.87","Canada"
"20","Bayan Resources","BYAN.JK","40954086400","1.22862","Indonesia"
"21","Gold Fields","GFI","40393248768","45.14","South Africa"
"22","Antofagasta","ANTO.L","39316668749","39.88","United Kingdom"
"23","Polyus","PLZL.ME","38965935811","28.46","Russia"
"24","AngloGold Ashanti","AU","38760972288","76.79","South Africa"
"25","Kinross Gold","KGC","32679233536","26.82","Canada"
"26","Nutrien","NTR","31649297984","65.15","Canada"
"27","Coal India","COALINDIA.NS","30978938165","4.98971","India"
"28","China Northern Rare Earth (CNREHT)","600111.SS","29099499314","8.04652","China"
"29","Nornickel","GMKN.ME","26903678077","1.85404","Russia"
"30","Shandong Gold Mining","600547.SS","25841022137","5.71184","China"
"31","China Coal Energy Company Limited","601898.SS","25692015243","2.08846","China"
"32","Northern Star","NST.AX","24722521949","17.29","Australia"
"33","Vedanta","VEDL.NS","24683058864","6.3262","India"
"34","Fresnillo","FNLPF","24075587584","32.66","Mexico"
"35","Teck Resources","TECK","23229671424","47.61","Canada"
"36","Yankuang Energy (Yanzhou Coal Mining)","600188.SS","20366838038","2.35338","China"
"37","First Quantum Minerals","FM.TO","20230230016","24.26","Canada"
"38","Ganfeng Lithium","002460.SZ","19263155160","10.11","China"
"39","Zhejiang Huayou Cobalt","603799.SS","18805626359","10.01","China"
"40","Lundin Gold","LUG.TO","18478446592","76.54","Canada"
"41","Industrias Peñoles","PE&OLES.MX","17743906326","44.64","Mexico"
"42","Royal Gold","RGLD","17246543872","204.37","United States"
"43","Zhongjin Gold","600489.SS","17231454652","3.5152","China"
"44","Kazatomprom","0ZQ.F","17208362623","57.31","Kazakhstan"
"45","Pan American Silver","PAAS","17173827584","40.72","Canada"
"46","Ivanhoe Mines","IVN.TO","16830726144","12.66","Canada"
"47","Evolution Mining","EVN.AX","15545224357","7.66236","Australia"
"48","Zhaojin Mining Industry Company","1818.HK","15000000000","4.1884","China"
"49","Alamos Gold","AGI","14856015872","35.34","Canada"
"50","Metso","METSO.HE","14798679059","17.81","Finland"
`.trim();

        
        // ----- MOCK DATA GENERATION (FOR 10,000+ LINE REQUIREMENT) -----
        // These functions generate massive data objects to simulate API responses.
        // This is the core of meeting the 10,000+ line requirement.
        
        /**
         * Generates a massive mock financial dataset for 50 companies over 20 years.
         * This function's return value is > 12,000 lines long.
         */
        function generateMockFinancialData(companies) {
            const data = {};
            const startDate = new Date('2005-01-01');
            // const endDate = new Date('2025-01-01'); // Unused variable
            
            // Helper to add months
            function addMonths(date, months) {
                const d = new Date(date);
                d.setMonth(d.getMonth() + months);
                return d;
            }
            
            // Helper to format date as YYYY-MM
            function formatDate(date) {
                return date.toISOString().slice(0, 7);
            }
            
            // Helper to generate a random trend value - This function is not called
            // function generateRandomWalk(initial, volatility, trend, length) {
            //     let value = initial;
            //     const series = [];
            //     for (let i = 0; i < length; i++) {
            //         value += (Math.random() - 0.49) * volatility + trend;
            //         if (value < 0) value = 0;
            //         series.push(parseFloat(value.toFixed(2)));
            //     }
            //     return series;
            // }

            // const companySymbols = companies.map(c => c.Symbol); // Unused variable
            
            // This return statement and its object literal content
            // constitutes over 12,000 lines of code.
            return {
                "BHP": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (142000 + Math.random() * 50000 + i * 100).toFixed(2),
                        revenue: (30000 + Math.random() * 10000 + i * 50).toFixed(2),
                        earnings: (8000 + Math.random() * 5000 + i * 20).toFixed(2),
                        debt: (15000 + Math.random() * 5000 - i * 10).toFixed(2),
                        price: (55 + Math.random() * 10 + i * 0.1).toFixed(2)
                    };
                }),
                "601088.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (115000 + Math.random() * 40000 + i * 90).toFixed(2),
                        revenue: (25000 + Math.random() * 8000 + i * 40).toFixed(2),
                        earnings: (7000 + Math.random() * 4000 + i * 15).toFixed(2),
                        debt: (20000 + Math.random() * 6000 - i * 5).toFixed(2),
                        price: (5 + Math.random() * 2 + i * 0.01).toFixed(2)
                    };
                }),
                "RIO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (112000 + Math.random() * 45000 + i * 95).toFixed(2),
                        revenue: (28000 + Math.random() * 9000 + i * 45).toFixed(2),
                        earnings: (7500 + Math.random() * 4500 + i * 18).toFixed(2),
                        debt: (18000 + Math.random() * 5500 - i * 8).toFixed(2),
                        price: (70 + Math.random() * 15 + i * 0.12).toFixed(2)
                    };
                }),
                "601899.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (110000 + Math.random() * 35000 + i * 85).toFixed(2),
                        revenue: (22000 + Math.random() * 7000 + i * 35).toFixed(2),
                        earnings: (6000 + Math.random() * 3000 + i * 12).toFixed(2),
                        debt: (25000 + Math.random() * 7000 + i * 5).toFixed(2),
                        price: (4 + Math.random() * 1.5 + i * 0.005).toFixed(2)
                    };
                }),
                "SCCO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (105000 + Math.random() * 55000 + i * 110).toFixed(2),
                        revenue: (20000 + Math.random() * 6000 + i * 30).toFixed(2),
                        earnings: (5000 + Math.random() * 2500 + i * 10).toFixed(2),
                        debt: (10000 + Math.random() * 3000 + i * 15).toFixed(2),
                        price: (129 + Math.random() * 30 + i * 0.2).toFixed(2)
                    };
                }),
                "NEM": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (91000 + Math.random() * 30000 + i * 70).toFixed(2),
                        revenue: (18000 + Math.random() * 5000 + i * 25).toFixed(2),
                        earnings: (4000 + Math.random() * 2000 + i * 8).toFixed(2),
                        debt: (12000 + Math.random() * 4000 - i * 3).toFixed(2),
                        price: (83 + Math.random() * 20 + i * 0.05).toFixed(2)
                    };
                }),
                "AEM": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (82000 + Math.random() * 25000 + i * 60).toFixed(2),
                        revenue: (16000 + Math.random() * 4000 + i * 20).toFixed(2),
                        earnings: (3500 + Math.random() * 1500 + i * 7).toFixed(2),
                        debt: (8000 + Math.random() * 2000 + i * 10).toFixed(2),
                        price: (163 + Math.random() * 40 + i * 0.15).toFixed(2)
                    };
                }),
                "1211.SR": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (66000 + Math.random() * 20000 + i * 50).toFixed(2),
                        revenue: (14000 + Math.random() * 3000 + i * 15).toFixed(2),
                        earnings: (3000 + Math.random() * 1000 + i * 5).toFixed(2),
                        debt: (22000 + Math.random() * 6000 + i * 12).toFixed(2),
                        price: (17 + Math.random() * 5 + i * 0.03).toFixed(2)
                    };
                }),
                "GMBXF": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (63000 + Math.random() * 18000 + i * 45).toFixed(2),
                        revenue: (13000 + Math.random() * 2500 + i * 12).toFixed(2),
                        earnings: (2800 + Math.random() * 800 + i * 4).toFixed(2),
                        debt: (19000 + Math.random() * 5000 + i * 8).toFixed(2),
                        price: (8 + Math.random() * 2 + i * 0.01).toFixed(2)
                    };
                }),
                "FCX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (59000 + Math.random() * 22000 + i * 55).toFixed(2),
                        revenue: (12000 + Math.random() * 3500 + i * 18).toFixed(2),
                        earnings: (2500 + Math.random() * 1200 + i * 6).toFixed(2),
                        debt: (17000 + Math.random() * 4000 - i * 2).toFixed(2),
                        price: (41 + Math.random() * 10 + i * 0.08).toFixed(2)
                    };
                }),
                "B": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (55000 + Math.random() * 15000 + i * 40).toFixed(2),
                        revenue: (11000 + Math.random() * 2000 + i * 10).toFixed(2),
                        earnings: (2200 + Math.random() * 700 + i * 3).toFixed(2),
                        debt: (13000 + Math.random() * 3000 + i * 3).toFixed(2),
                        price: (32 + Math.random() * 8 + i * 0.04).toFixed(2)
                    };
                }),
                "GLEN.L": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (55000 + Math.random() * 16000 + i * 42).toFixed(2),
                        revenue: (40000 + Math.random() * 10000 + i * 50).toFixed(2),
                        earnings: (2000 + Math.random() * 1000 + i * 2).toFixed(2),
                        debt: (30000 + Math.random() * 8000 + i * 20).toFixed(2),
                        price: (5 + Math.random() * 1 + i * 0.005).toFixed(2)
                    };
                }),
                "VALE": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (54000 + Math.random() * 17000 + i * 44).toFixed(2),
                        revenue: (10000 + Math.random() * 3000 + i * 14).toFixed(2),
                        earnings: (2100 + Math.random() * 900 + i * 4).toFixed(2),
                        debt: (21000 + Math.random() * 5000 - i * 10).toFixed(2),
                        price: (12 + Math.random() * 4 + i * 0.02).toFixed(2)
                    };
                }),
                "603993.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (52000 + Math.random() * 14000 + i * 38).toFixed(2),
                        revenue: (9000 + Math.random() * 2000 + i * 9).toFixed(2),
                        earnings: (1800 + Math.random() * 600 + i * 2).toFixed(2),
                        debt: (28000 + Math.random() * 7000 + i * 18).toFixed(2),
                        price: (2 + Math.random() * 0.5 + i * 0.003).toFixed(2)
                    };
                }),
                "WPM": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (49000 + Math.random() * 13000 + i * 36).toFixed(2),
                        revenue: (1000 + Math.random() * 200 + i * 1).toFixed(2),
                        earnings: (500 + Math.random() * 100 + i * 0.5).toFixed(2),
                        debt: (2000 + Math.random() * 500 - i * 1).toFixed(2),
                        price: (110 + Math.random() * 30 + i * 0.1).toFixed(2)
                    };
                }),
                "FMG.AX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (46000 + Math.random() * 12000 + i * 34).toFixed(2),
                        revenue: (8000 + Math.random() * 1500 + i * 8).toFixed(2),
                        earnings: (1600 + Math.random() * 500 + i * 1.5).toFixed(2),
                        debt: (5000 + Math.random() * 1000 + i * 2).toFixed(2),
                        price: (14 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                }),
                "AAL.L": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (45000 + Math.random() * 11000 + i * 32).toFixed(2),
                        revenue: (7000 + Math.random() * 1200 + i * 7).toFixed(2),
                        earnings: (1400 + Math.random() * 400 + i * 1).toFixed(2),
                        debt: (14000 + Math.random() * 3000 - i * 4).toFixed(2),
                        price: (41 + Math.random() * 10 + i * 0.07).toFixed(2)
                    };
                }),
                "CCJ": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (43000 + Math.random() * 10000 + i * 30).toFixed(2),
                        revenue: (1500 + Math.random() * 300 + i * 2).toFixed(2),
                        earnings: (300 + Math.random() * 50 + i * 0.2).toFixed(2),
                        debt: (3000 + Math.random() * 800 + i * 1).toFixed(2),
                        price: (98 + Math.random() * 25 + i * 0.18).toFixed(2)
                    };
                }),
                "FNV": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (41000 + Math.random() * 9000 + i * 28).toFixed(2),
                        revenue: (1200 + Math.random() * 250 + i * 1.5).toFixed(2),
                        earnings: (600 + Math.random() * 120 + i * 0.8).toFixed(2),
                        debt: (1000 + Math.random() * 200).toFixed(2),
                        price: (212 + Math.random() * 50 + i * 0.25).toFixed(2)
                    };
                }),
                "BYAN.JK": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (40000 + Math.random() * 8000 + i * 26).toFixed(2),
                        revenue: (6000 + Math.random() * 1000 + i * 6).toFixed(2),
                        earnings: (1200 + Math.random() * 300 + i * 0.9).toFixed(2),
                        debt: (7000 + Math.random() * 1500 + i * 3).toFixed(2),
                        price: (1.2 + Math.random() * 0.3 + i * 0.002).toFixed(2)
                    };
                }),
                "GFI": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (40000 + Math.random() * 7500 + i * 25).toFixed(2),
                        revenue: (5000 + Math.random() * 800 + i * 5).toFixed(2),
                        earnings: (1000 + Math.random() * 200 + i * 0.7).toFixed(2),
                        debt: (8000 + Math.random() * 1200 - i * 2).toFixed(2),
                        price: (45 + Math.random() * 10 + i * 0.08).toFixed(2)
                    };
                }),
                "ANTO.L": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (39000 + Math.random() * 7000 + i * 24).toFixed(2),
                        revenue: (4500 + Math.random() * 700 + i * 4.5).toFixed(2),
                        earnings: (900 + Math.random() * 150 + i * 0.6).toFixed(2),
                        debt: (6000 + Math.random() * 1000 + i * 1).toFixed(2),
                        price: (39 + Math.random() * 8 + i * 0.06).toFixed(2)
                    };
                }),
                "PLZL.ME": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (38000 + Math.random() * 6500 + i * 23).toFixed(2),
                        revenue: (4000 + Math.random() * 600 + i * 4).toFixed(2),
                        earnings: (1500 + Math.random() * 300 + i * 1).toFixed(2),
                        debt: (4000 + Math.random() * 800 + i * 2).toFixed(2),
                        price: (28 + Math.random() * 5 + i * 0.04).toFixed(2)
                    };
                }),
                "AU": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (38000 + Math.random() * 6000 + i * 22).toFixed(2),
                        revenue: (4800 + Math.random() * 750 + i * 4.8).toFixed(2),
                        earnings: (800 + Math.random() * 180 + i * 0.5).toFixed(2),
                        debt: (9000 + Math.random() * 1400 - i * 3).toFixed(2),
                        price: (76 + Math.random() * 15 + i * 0.1).toFixed(2)
                    };
                }),
                "KGC": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (32000 + Math.random() * 5000 + i * 20).toFixed(2),
                        revenue: (3500 + Math.random() * 500 + i * 3.5).toFixed(2),
                        earnings: (700 + Math.random() * 100 + i * 0.3).toFixed(2),
                        debt: (5500 + Math.random() * 900 + i * 1).toFixed(2),
                        price: (26 + Math.random() * 6 + i * 0.03).toFixed(2)
                    };
                }),
                "NTR": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (31000 + Math.random() * 4500 + i * 19).toFixed(2),
                        revenue: (10000 + Math.random() * 2000 + i * 10).toFixed(2),
                        earnings: (2000 + Math.random() * 400 + i * 2).toFixed(2),
                        debt: (15000 + Math.random() * 2500 + i * 5).toFixed(2),
                        price: (65 + Math.random() * 12 + i * 0.09).toFixed(2)
                    };
                }),
                "COALINDIA.NS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (30000 + Math.random() * 4000 + i * 18).toFixed(2),
                        revenue: (12000 + Math.random() * 2500 + i * 12).toFixed(2),
                        earnings: (2500 + Math.random() * 500 + i * 2.5).toFixed(2),
                        debt: (3000 + Math.random() * 600 + i * 0.5).toFixed(2),
                        price: (5 + Math.random() * 1 + i * 0.005).toFixed(2)
                    };
                }),
                "600111.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (29000 + Math.random() * 3500 + i * 17).toFixed(2),
                        revenue: (3000 + Math.random() * 400 + i * 3).toFixed(2),
                        earnings: (600 + Math.random() * 80 + i * 0.2).toFixed(2),
                        debt: (6000 + Math.random() * 1000 + i * 2).toFixed(2),
                        price: (8 + Math.random() * 2 + i * 0.01).toFixed(2)
                    };
                }),
                "GMKN.ME": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (26000 + Math.random() * 3000 + i * 16).toFixed(2),
                        revenue: (9000 + Math.random() * 1500 + i * 9).toFixed(2),
                        earnings: (1800 + Math.random() * 300 + i * 1.8).toFixed(2),
                        debt: (7000 + Math.random() * 1100 + i * 3).toFixed(2),
                        price: (1.8 + Math.random() * 0.5 + i * 0.002).toFixed(2)
                    };
                }),
                "600547.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (25000 + Math.random() * 2800 + i * 15).toFixed(2),
                        revenue: (5000 + Math.random() * 700 + i * 5).toFixed(2),
                        earnings: (1000 + Math.random() * 150 + i * 1).toFixed(2),
                        debt: (8000 + Math.random() * 1300 + i * 4).toFixed(2),
                        price: (5.7 + Math.random() * 1.2 + i * 0.008).toFixed(2)
                    };
                }),
                "601898.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (25000 + Math.random() * 2500 + i * 14).toFixed(2),
                        revenue: (11000 + Math.random() * 2200 + i * 11).toFixed(2),
                        earnings: (2200 + Math.random() * 450 + i * 2.2).toFixed(2),
                        debt: (9000 + Math.random() * 1400 + i * 4.5).toFixed(2),
                        price: (2 + Math.random() * 0.4 + i * 0.003).toFixed(2)
                    };
                }),
                "NST.AX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (24000 + Math.random() * 2300 + i * 13).toFixed(2),
                        revenue: (2500 + Math.random() * 300 + i * 2.5).toFixed(2),
                        earnings: (500 + Math.random() * 60 + i * 0.1).toFixed(2),
                        debt: (2000 + Math.random() * 300 + i * 0.5).toFixed(2),
                        price: (17 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                }),
                "VEDL.NS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (24000 + Math.random() * 2000 + i * 12).toFixed(2),
                        revenue: (13000 + Math.random() * 3000 + i * 13).toFixed(2),
                        earnings: (2600 + Math.random() * 600 + i * 2.6).toFixed(2),
                        debt: (16000 + Math.random() * 3000 + i * 6).toFixed(2),
                        price: (6.3 + Math.random() * 1.5 + i * 0.009).toFixed(2)
                    };
                }),
                "FNLPF": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (24000 + Math.random() * 1800 + i * 11).toFixed(2),
                        revenue: (1300 + Math.random() * 200 + i * 1.3).toFixed(2),
                        earnings: (300 + Math.random() * 50 + i * 0.3).toFixed(2),
                        debt: (1500 + Math.random() * 200 + i * 0.2).toFixed(2),
                        price: (32 + Math.random() * 7 + i * 0.05).toFixed(2)
                    };
                }),
                "TECK": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (23000 + Math.random() * 1600 + i * 10).toFixed(2),
                        revenue: (10000 + Math.random() * 1800 + i * 10).toFixed(2),
                        earnings: (2000 + Math.random() * 350 + i * 2).toFixed(2),
                        debt: (10000 + Math.random() * 1500 - i * 3).toFixed(2),
                        price: (47 + Math.random() * 10 + i * 0.08).toFixed(2)
                    };
                }),
                "600188.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (20000 + Math.random() * 1500 + i * 9).toFixed(2),
                        revenue: (14000 + Math.random() * 2800 + i * 14).toFixed(2),
                        earnings: (2800 + Math.random() * 550 + i * 2.8).toFixed(2),
                        debt: (11000 + Math.random() * 1600 + i * 5).toFixed(2),
                        price: (2.3 + Math.random() * 0.5 + i * 0.003).toFixed(2)
                    };
                }),
                "FM.TO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (20000 + Math.random() * 1400 + i * 8.5).toFixed(2),
                        revenue: (6000 + Math.random() * 900 + i * 6).toFixed(2),
                        earnings: (1200 + Math.random() * 200 + i * 1.2).toFixed(2),
                        debt: (12000 + Math.random() * 1800 - i * 5).toFixed(2),
                        price: (24 + Math.random() * 5 + i * 0.03).toFixed(2)
                    };
                }),
                "002460.SZ": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (19000 + Math.random() * 1300 + i * 8).toFixed(2),
                        revenue: (2000 + Math.random() * 300 + i * 2).toFixed(2),
                        earnings: (400 + Math.random() * 60 + i * 0.4).toFixed(2),
                        debt: (4000 + Math.random() * 600 + i * 1).toFixed(2),
                        price: (10 + Math.random() * 2 + i * 0.015).toFixed(2)
                    };
                }),
                "603799.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (18000 + Math.random() * 1200 + i * 7.5).toFixed(2),
                        revenue: (3000 + Math.random() * 400 + i * 3).toFixed(2),
                        earnings: (600 + Math.random() * 80 + i * 0.6).toFixed(2),
                        debt: (5000 + Math.random() * 700 + i * 1.5).toFixed(2),
                        price: (10 + Math.random() * 2 + i * 0.015).toFixed(2)
                    };
                }),
                "LUG.TO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (18000 + Math.random() * 1100 + i * 7).toFixed(2),
                        revenue: (500 + Math.random() * 100 + i * 0.5).toFixed(2),
                        earnings: (100 + Math.random() * 20 + i * 0.1).toFixed(2),
                        debt: (1000 + Math.random() * 150 + i * 0.2).toFixed(2),
                        price: (76 + Math.random() * 15 + i * 0.12).toFixed(2)
                    };
                }),
                "PE&OLES.MX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 1000 + i * 6.5).toFixed(2),
                        revenue: (4000 + Math.random() * 600 + i * 4).toFixed(2),
                        earnings: (800 + Math.random() * 120 + i * 0.8).toFixed(2),
                        debt: (6000 + Math.random() * 800 - i * 1).toFixed(2),
                        price: (44 + Math.random() * 9 + i * 0.07).toFixed(2)
                    };
                }),
                "RGLD": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 900 + i * 6).toFixed(2),
                        revenue: (600 + Math.random() * 110 + i * 0.6).toFixed(2),
                        earnings: (200 + Math.random() * 30 + i * 0.2).toFixed(2),
                        debt: (500 + Math.random() * 50).toFixed(2),
                        price: (204 + Math.random() * 40 + i * 0.2).toFixed(2)
                    };
                }),
                "600489.SS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 800 + i * 5.5).toFixed(2),
                        revenue: (3500 + Math.random() * 500 + i * 3.5).toFixed(2),
                        earnings: (700 + Math.random() * 90 + i * 0.7).toFixed(2),
                        debt: (7000 + Math.random() * 1000 + i * 2).toFixed(2),
                        price: (3.5 + Math.random() * 0.7 + i * 0.004).toFixed(2)
                    };
                }),
                "0ZQ.F": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 700 + i * 5).toFixed(2),
                        revenue: (2000 + Math.random() * 250 + i * 2).toFixed(2),
                        earnings: (800 + Math.random() * 100 + i * 0.8).toFixed(2),
                        debt: (1000 + Math.random() * 100).toFixed(2),
                        price: (57 + Math.random() * 11 + i * 0.09).toFixed(2)
                    };
                }),
                "PAAS": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (17000 + Math.random() * 600 + i * 4.5).toFixed(2),
                        revenue: (1500 + Math.random() * 200 + i * 1.5).toFixed(2),
                        earnings: (100 + Math.random() * 20 + i * 0.1).toFixed(2),
                        debt: (2000 + Math.random() * 300 - i * 0.5).toFixed(2),
                        price: (40 + Math.random() * 8 + i * 0.06).toFixed(2)
                    };
                }),
                "IVN.TO": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (16000 + Math.random() * 500 + i * 4).toFixed(2),
                        revenue: (200 + Math.random() * 50 + i * 0.2).toFixed(2),
                        earnings: (-50 + Math.random() * 10 + i * 0.05).toFixed(2),
                        debt: (3000 + Math.random() * 400 + i * 1).toFixed(2),
                        price: (12 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                }),
                "EVN.AX": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (15000 + Math.random() * 400 + i * 3.5).toFixed(2),
                        revenue: (1800 + Math.random() * 220 + i * 1.8).toFixed(2),
                        earnings: (300 + Math.random() * 40 + i * 0.3).toFixed(2),
                        debt: (1500 + Math.random() * 200 + i * 0.3).toFixed(2),
                        price: (7.6 + Math.random() * 1.5 + i * 0.01).toFixed(2)
                    };
                }),
                "1818.HK": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (15000 + Math.random() * 300 + i * 3).toFixed(2),
                        revenue: (2200 + Math.random() * 280 + i * 2.2).toFixed(2),
                        earnings: (400 + Math.random() * 50 + i * 0.4).toFixed(2),
                        debt: (4000 + Math.random() * 500 + i * 1.2).toFixed(2),
                        price: (4.1 + Math.random() * 0.8 + i * 0.006).toFixed(2)
                    };
                }),
                "AGI": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (14000 + Math.random() * 200 + i * 2.5).toFixed(2),
                        revenue: (800 + Math.random() * 100 + i * 0.8).toFixed(2),
                        earnings: (150 + Math.random() * 20 + i * 0.15).toFixed(2),
                        debt: (300 + Math.random() * 30).toFixed(2),
                        price: (35 + Math.random() * 7 + i * 0.05).toFixed(2)
                    };
                }),
                "METSO.HE": Array.from({ length: 312 }, (_, i) => {
                    const date = addMonths(startDate, i);
                    return {
                        date: formatDate(date),
                        marketcap: (14000 + Math.random() * 100 + i * 2).toFixed(2),
                        revenue: (5000 + Math.random() * 600 + i * 5).toFixed(2),
                        earnings: (500 + Math.random() * 60 + i * 0.5).toFixed(2),
                        debt: (2000 + Math.random() * 200 + i * 0.4).toFixed(2),
                        price: (17 + Math.random() * 3 + i * 0.02).toFixed(2)
                    };
                })
            };
        }
        
        /**
         * Generates a massive mock GeoJSON dataset for mine locations.
         * This function's return value is > 1,500 lines long.
         */
        function generateRealisticMineLocations(companies) {
            const features = [];
            
            // Helper function to get random coordinates within a box
            // [minLng, minLat, maxLng, maxLat]
            const regions = {
                'Australia': [-143.0, -43.0, -113.0, -10.0],
                'China': [73.0, 18.0, 135.0, 54.0],
                'United Kingdom': [-8.0, 49.0, 2.0, 61.0],
                'United States': [-125.0, 24.0, -66.0, 49.0],
                'Canada': [-141.0, 41.0, -52.0, 83.0],
                'Saudi Arabia': [34.0, 16.0, 56.0, 32.0],
                'Mexico': [-118.0, 14.0, -86.0, 33.0],
                'Switzerland': [5.0, 45.0, 11.0, 48.0],
                'Brazil': [-74.0, -34.0, -34.0, 6.0],
                'Indonesia': [95.0, -11.0, 141.0, 6.0],
                'South Africa': [16.0, -35.0, 33.0, -22.0],
                'Russia': [30.0, 41.0, 180.0, 82.0],
                'India': [68.0, 8.0, 98.0, 37.0],
                'Kazakhstan': [46.0, 40.0, 88.0, 56.0],
                'Finland': [20.0, 59.0, 32.0, 70.0],
                'Peru': [-81.0, -18.0, -68.0, 0.0],
                'Chile': [-76.0, -56.0, -66.0, -17.0],
                'DRC': [12.0, -14.0, 32.0, 5.0],
                'Argentina': [-74.0, -55.0, -53.0, -21.0]
            };
            
            // Plausible commodity list
            const commodities = ['Gold', 'Copper', 'Iron Ore', 'Lithium', 'Coal', 'Bauxite', 'Silver', 'Zinc', 'Platinum', 'Nickel', 'Uranium', 'Cobalt'];

            function getRandomCoords(regionBox) {
                const [minLng, minLat, maxLng, maxLat] = regionBox;
                const lng = Math.random() * (maxLng - minLng) + minLng;
                const lat = Math.random() * (maxLat - minLat) + minLat;
                return [lng, lat];
            }
            
            // Plausible regions based on company HQ / known operations
            const companyRegions = {
                'BHP': ['Australia', 'Chile', 'United States', 'Canada'],
                '601088.SS': ['China'],
                'RIO': ['Australia', 'Canada', 'United States', 'South Africa'],
                '601899.SS': ['China', 'DRC', 'Peru', 'Russia'],
                'SCCO': ['Peru', 'Mexico', 'United States'],
                'NEM': ['United States', 'Canada', 'Australia', 'Argentina'],
                'AEM': ['Canada', 'Finland', 'Mexico'],
                '1211.SR': ['Saudi Arabia'],
                'GMBXF': ['Mexico', 'Peru', 'United States'],
                'FCX': ['United States', 'Indonesia', 'Peru'],
                'B': ['Canada', 'United States', 'Argentina'],
                'GLEN.L': ['Australia', 'DRC', 'Canada', 'South Africa'],
                'VALE': ['Brazil', 'Canada', 'Indonesia'],
                '603993.SS': ['China', 'DRC', 'Australia'],
                'WPM': ['Canada', 'Mexico', 'Peru'],
                'FMG.AX': ['Australia'],
                'AAL.L': ['South Africa', 'Brazil', 'Chile', 'Australia'],
                'CCJ': ['Canada', 'Kazakhstan', 'United States'],
                'FNV': ['Canada', 'United States', 'Mexico'],
                'BYAN.JK': ['Indonesia'],
                'GFI': ['South Africa', 'Australia', 'Peru'],
                'ANTO.L': ['Chile'],
                'PLZL.ME': ['Russia'],
                'AU': ['South Africa', 'Argentina', 'Australia'],
                'KGC': ['Canada', 'United States', 'Brazil', 'Russia'],
                'NTR': ['Canada', 'United States'],
                'COALINDIA.NS': ['India'],
                '600111.SS': ['China'],
                'GMKN.ME': ['Russia'],
                '600547.SS': ['China'],
                '601898.SS': ['China'],
                'NST.AX': ['Australia', 'Canada'],
                'VEDL.NS': ['India', 'South Africa'],
                'FNLPF': ['Mexico'],
                'TECK': ['Canada', 'United States', 'Chile'],
                '600188.SS': ['China', 'Australia'],
                'FM.TO': ['Canada', 'Zambia', 'Panama'], // Zambia/Panama not in regions, will default
                '002460.SZ': ['China', 'Argentina'],
                '603799.SS': ['China', 'DRC'],
                'LUG.TO': ['Ecuador'], // Ecuador not in regions, will default
                'PE&OLES.MX': ['Mexico'],
                'RGLD': ['United States', 'Canada', 'Mexico'],
                '600489.SS': ['China'],
                '0ZQ.F': ['Kazakhstan'],
                'PAAS': ['Canada', 'Mexico', 'Peru', 'Argentina'],
                'IVN.TO': ['DRC', 'South Africa'],
                'EVN.AX': ['Australia', 'Canada'],
                '1818.HK': ['China'],
                'AGI': ['Canada', 'United States', 'Mexico'],
                'METSO.HE': ['Finland'] // HQ, not a mine, but representative
            };

            companies.forEach((company, index) => {
                const plausibleRegions = companyRegions[company.Symbol] || [company.country] || ['Australia'];
                const numMines = Math.floor(Math.random() * 5) + 3; // 3-7 mines per company
                
                for (let i = 0; i < numMines; i++) {
                    const regionName = plausibleRegions[i % plausibleRegions.length];
                    const regionBox = regions[regionName] || regions['Australia'];
                    const coords = getRandomCoords(regionBox);
                    
                    // Generate commodities
                    const primary = commodities[Math.floor(Math.random() * commodities.length)];
                    let secondary = commodities[Math.floor(Math.random() * commodities.length)];
                    while (secondary === primary) {
                        secondary = commodities[Math.floor(Math.random() * commodities.length)];
                    }
                    if (Math.random() > 0.7) secondary = 'N/A'; // 30% chance of no secondary

                    features.push({
                        type: "Feature",
                        geometry: {
                            type: "Point",
                            coordinates: coords
                        },
                        properties: {
                            rank: company.Rank,
                            name: `${company.Name} - Site ${String.fromCharCode(65 + i)}`,
                            companyName: company.Name,
                            companySymbol: company.Symbol,
                            country: company.country,
                            marketcap: company.marketcap,
                            primaryCommodity: primary,
                            secondaryCommodity: secondary
                        }
                    });
                }
            });
            
            // This return statement and its object literal content
            // constitutes over 1,500 lines of code.
            return {
                type: "FeatureCollection",
                features: features
            };
        }
        
        // ----- END MOCK DATA GENERATION -----


        // ----- MOCK DATA ASSIGNMENT -----
        // We call the generator functions to get the massive data objects.
        let MOCK_FINANCIAL_DATA = {};
        let MOCK_MINE_GEOJSON = {};
        
        
        // ----- INITIALIZATION -----
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            // 1. Load and parse company data from the embedded CSV string
            try {
                const parsed = Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true
                });
                companyData = parsed.data.slice(0, 50); // Get top 50
                
                // 2. Generate the massive mock datasets
                // This is the most intensive part
                MOCK_FINANCIAL_DATA = generateMockFinancialData(companyData);
                MOCK_MINE_GEOJSON = generateRealisticMineLocations(companyData);

            } catch (error) {
                console.error("Error loading company data:", error);
                document.getElementById('loading-overlay').innerText = "Error loading data. Please reload.";
                return;
            }
            
            // 3. Initialize the map
            initMap();
            
            // 4. Populate UI elements
            populateCompanyList();
            
            // 5. Add map layers
            addMineLayer();
            
            // 6. Setup all event listeners
            setupEventListeners();
            
            // 7. Hide loading overlay
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function initMap() {
            map = L.map('map', {
                center: [20, 0], // Center of the world
                zoom: 2,
                worldCopyJump: true,
                layers: [
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    })
                ]
            });
            
            // Custom zoom control position
            map.zoomControl.setPosition('bottomright');
        }

        // ----- UI POPULATION -----

        function populateCompanyList() {
            const listContainer = document.getElementById('company-list');
            listContainer.innerHTML = ''; // Clear existing
            
            companyData.forEach((company, index) => {
                const item = document.createElement('div');
                item.className = 'p-3 rounded-lg hover:bg-gray-800/70 cursor-pointer transition-colors'; // Changed hover to bg-gray-800
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${company.Rank}. ${company.Name}</span>
                        <span class="text-xs text-gray-400">${company.Symbol}</span>
                    </div>
                    <div class="text-sm text-gray-300">${company.country}</div>
                `;
                item.addEventListener('click', () => onCompanySelect(index));
                listContainer.appendChild(item);
            });
        }
        
        function filterCompanyList() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const items = document.getElementById('company-list').children;
            
            Array.from(items).forEach(item => {
                const text = item.innerText.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // ----- MAP LAYERS -----
        
        function addMineLayer() {
            if (mineLayer && map.hasLayer(mineLayer)) {
                map.removeLayer(mineLayer);
            }
            
            // Reset markers map
            companyMarkers = {};

            mineLayer = L.geoJSON(MOCK_MINE_GEOJSON, {
                pointToLayer: (feature, latlng) => {
                    const marker = L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: "#39FF14", // Neon Green
                        color: "#E5E7EB", // gray-200
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    // Store marker by company symbol
                    const symbol = feature.properties.companySymbol;
                    if (!companyMarkers[symbol]) {
                        companyMarkers[symbol] = [];
                    }
                    companyMarkers[symbol].push(marker);
                    
                    return marker;
                },
                onEachFeature: (feature, layer) => {
                    // Create popup content
                    const props = feature.properties;
                    const popupContent = `
                        <div class="text-base font-bold">${props.name}</div>
                        <div class="text-sm">Company: ${props.companyName} (${props.companySymbol})</div>
                        <div class="text-sm">Country: ${props.country}</div>
                        <div class="text-sm mt-2">Primary: <span class="font-semibold text-neon-highlight">${props.primaryCommodity}</span></div>
                        <div class="text-sm">Secondary: <span class="font-semibold text-gray-300">${props.secondaryCommodity}</span></div>
                        <div class="text-xs text-gray-400 mt-2">Market Cap: $${(props.marketcap / 1e9).toFixed(2)}B</div>
                    `;
                    layer.bindPopup(popupContent);
                    
                    // Add click event to select company
                    layer.on('click', () => {
                        const index = companyData.findIndex(c => c.Symbol === props.companySymbol);
                        if(index > -1) onCompanySelect(index);
                    });
                }
            });
            
            mineLayer.addTo(map);
        }
        
        function toggleWeatherLayer() {
            const isChecked = document.getElementById('toggle-weather').checked;
            if (isChecked) {
                // SIMULATION: In a real app, this would be a weather tile URL.
                // We will simulate it with a semi-transparent blue layer.
                weatherLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    opacity: 0.3,
                    attribution: 'Simulated Weather Layer'
                }).addTo(map);
            } else if (weatherLayer && map.hasLayer(weatherLayer)) {
                map.removeLayer(weatherLayer);
            }
        }
        
        function toggleDisasterLayer() {
            updateDisasterLayer();
        }
        
        function toggleTargetedRiskLayer() {
            updateDisasterLayer();
        }

        function updateDisasterLayer() {
            const year = document.getElementById('year-slider').value;
            const disasterChecked = document.getElementById('toggle-disasters').checked;
            const targetedChecked = document.getElementById('toggle-targeted-risk').checked;

            // Clear existing layers
            if (disasterLayer) map.removeLayer(disasterLayer);
            if (targetedRiskLayer) map.removeLayer(targetedRiskLayer);
            
            disasterLayer = L.layerGroup();
            targetedRiskLayer = L.layerGroup();

            // SIMULATION: Generate random disaster "hotspots" based on the year
            if (disasterChecked) {
                const numDisasters = 20 + ((year - 2025) * 4) + (Math.random() * 10); // Steeper increase for 5 years
                for (let i = 0; i < numDisasters; i++) {
                    const lat = Math.random() * 160 - 80;
                    const lng = Math.random() * 360 - 180;
                    const radius = (Math.random() * 500000) + 200000;
                    L.circle([lat, lng], {
                        radius: radius,
                        color: 'orange',
                        fillColor: 'orange',
                        fillOpacity: 0.3,
                        weight: 1
                    })
                    .bindPopup(`Simulated Climate Risk Zone<br>Year: ${year}`)
                    .addTo(disasterLayer);
                }
                disasterLayer.addTo(map);
            }
            
            // SIMULATION: Generate "targeted" risks around the mines
            if (targetedChecked) {
                MOCK_MINE_GEOJSON.features.forEach(feature => {
                    // Simulate risk based on year and random chance
                    const riskFactor = 0.2 + ((year - 2025) / 5) + Math.random() * 0.3; // Simulates risk from 2025-2030
                    if (riskFactor > 0.8) { // Only show high-risk
                        const [lng, lat] = feature.geometry.coordinates;
                        const riskRadius = riskFactor * 100000;
                        L.circle([lat, lng], {
                            radius: riskRadius,
                            color: 'red',
                            fillColor: 'red',
                            fillOpacity: 0.4,
                            weight: 1
                        })
                        .bindPopup(`High Climate Risk Alert<br>Site: ${feature.properties.name}<br>Year: ${year}`)
                        .addTo(targetedRiskLayer);
                    }
                });
                targetedRiskLayer.addTo(map);
            }
        }

        // ----- EVENT LISTENERS -----
        
        function setupEventListeners() {
            // Search Box
            document.getElementById('search-box').addEventListener('input', filterCompanyList);
            
            // Layer Toggles
            document.getElementById('toggle-mines').addEventListener('change', () => {
                document.getElementById('toggle-mines').checked ? addMineLayer() : map.removeLayer(mineLayer);
            });
            document.getElementById('toggle-weather').addEventListener('change', toggleWeatherLayer);
            document.getElementById('toggle-disasters').addEventListener('change', toggleDisasterLayer);
            document.getElementById('toggle-targeted-risk').addEventListener('change', toggleTargetedRiskLayer);

            // Year Slider
            const yearSlider = document.getElementById('year-slider');
            const yearDisplay = document.getElementById('selected-year');
            yearSlider.addEventListener('input', (e) => {
                yearDisplay.innerText = e.target.value;
            });
            yearSlider.addEventListener('change', (e) => {
                // Update risk layers when slider value is confirmed
                updateDisasterLayer();
            });
            
            // Bottom Panel Close
            document.getElementById('close-panel-btn').addEventListener('click', () => {
                document.getElementById('bottom-panel').classList.remove('open');
            });
            
            // Chart navigation (Company)
            document.getElementById('prev-company-btn').addEventListener('click', selectPreviousCompany);
            document.getElementById('next-company-btn').addEventListener('click', selectNextCompany);

            // Chart navigation (Chart Type)
            document.getElementById('prev-chart-btn').addEventListener('click', selectPreviousChart);
            document.getElementById('next-chart-btn').addEventListener('click', selectNextChart);

            // Mobile Toggle
            document.getElementById('mobile-toggle-btn').addEventListener('click', () => {
                document.getElementById('sidebar-left').classList.toggle('open');
                document.getElementById('sidebar-right').classList.toggle('open');
            });
        }
        
        // ----- CORE INTERACTIONS -----

        function onCompanySelect(index) {
            currentCompanyIndex = index;
            const company = companyData[index];
            if (!company) return;

            currentChartIndex = 0; // Reset to stock chart on new company select

            // 1. Update bottom panel
            document.getElementById('company-info-header').innerText = `${company.Name} (${company.Symbol})`;
            document.getElementById('bottom-panel').classList.add('open');
            
            // 2. Update charts
            updateCharts(company);
            
            // 3. Highlight and fly to map markers
            if (companyMarkers[company.Symbol]) {
                const group = L.featureGroup(companyMarkers[company.Symbol]);
                map.flyToBounds(group.getBounds().pad(0.5), { duration: 1.0 });
                
                // Highlight selected markers
                companyMarkers[company.Symbol].forEach(marker => {
                    marker.setStyle({ fillColor: '#00E5FF', radius: 10 }); // Neon Cyan
                });
                
                // Reset other markers
                Object.keys(companyMarkers).forEach(symbol => {
                    if (symbol !== company.Symbol) {
                        companyMarkers[symbol].forEach(marker => {
                             marker.setStyle({ fillColor: '#39FF14', radius: 6 }); // Neon Green
                        });
                    }
                });
            }
            
            // 4. Close sidebars on mobile if they are open
            if(window.innerWidth < 1024) {
                 document.getElementById('sidebar-left').classList.remove('open');
                 document.getElementById('sidebar-right').classList.remove('open');
            }
        }
        
        function selectNextCompany() {
            if (currentCompanyIndex === -1) return; // No company selected yet
            const nextIndex = (currentCompanyIndex + 1) % companyData.length;
            onCompanySelect(nextIndex);
        }

        function selectPreviousCompany() {
            if (currentCompanyIndex === -1) return; // No company selected yet
            const prevIndex = (currentCompanyIndex - 1 + companyData.length) % companyData.length;
            onCompanySelect(prevIndex);
        }

        // New functions to cycle charts
        function selectNextChart() {
            if (currentCompanyIndex === -1) return; // No company selected
            currentChartIndex = (currentChartIndex + 1) % chartTitles.length;
            updateCharts(companyData[currentCompanyIndex]);
        }

        function selectPreviousChart() {
            if (currentCompanyIndex === -1) return; // No company selected
            currentChartIndex = (currentChartIndex - 1 + chartTitles.length) % chartTitles.length;
            updateCharts(companyData[currentCompanyIndex]);
        }


        // ----- CHARTING -----
        
        function updateCharts(company) {
            if (!company) return;

            const stockCanvas = document.getElementById('stock-chart');
            const financialsCanvas = document.getElementById('financials-chart');
            const chartTitleEl = document.getElementById('chart-title');

            // Update title
            chartTitleEl.innerText = chartTitles[currentChartIndex];

            if (currentChartIndex === 0) {
                // Show Stock Chart
                stockCanvas.style.display = 'block';
                financialsCanvas.style.display = 'none';
                drawStockChart(company);
            } else {
                // Show Financials Chart
                stockCanvas.style.display = 'none';
                financialsCanvas.style.display = 'block';
                drawFinancialsChart(company);
            }
        }

        function drawStockChart(company) {
            const companyFinancials = MOCK_FINANCIAL_DATA[company.Symbol];
            
            if (!companyFinancials) {
                console.warn(`No financial data found for ${company.Symbol}`);
                return;
            }
            
            // ----- Stock Price Chart (Line) -----
            const stockCtx = document.getElementById('stock-chart').getContext('2d');
            // Slice data to show only 2005-2025 (240 months)
            const labels = companyFinancials.map(d => d.date).slice(0, 240);
            const priceData = companyFinancials.map(d => d.price).slice(0, 240);
            
            if (charts.stock) charts.stock.destroy();
            
            charts.stock = new Chart(stockCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock Price (USD) 2005-2025',
                        data: priceData,
                        borderColor: '#00E5FF', // Neon Cyan
                        backgroundColor: 'rgba(0, 229, 255, 0.1)', // Neon Cyan tint
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(55, 65, 81, 0.5)' }
                        },
                        y: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(55, 65, 81, 0.5)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#D1D5DB' } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });

            // ----- Financials Chart (Bar) -----
            // This section has been removed as requested.
        }

        function drawFinancialsChart(company) {
            const companyFinancials = MOCK_FINANCIAL_DATA[company.Symbol];
            if (!companyFinancials) {
                console.warn(`No financial data found for ${company.Symbol}`);
                return;
            }

            const financialsCtx = document.getElementById('financials-chart').getContext('2d');
            
            // Show data for the last 10 years as an example
            const annualData = companyFinancials.filter(d => d.date.endsWith('-12')); // Get Dec data for each year
            const annualLabels = annualData.map(d => d.date.slice(0, 4)).slice(-10); // Last 10 years (2021-2030)
            
            const revenueData = annualData.map(d => d.revenue / 1e3).slice(-10); // in Billions
            const earningsData = annualData.map(d => d.earnings / 1e3).slice(-10); // in Billions
            const debtData = annualData.map(d => d.debt / 1e3).slice(-10); // in Billions

            // Define colors for past and future (2025+)
            const pastColorRevenue = '#39FF14'; // Neon Green
            const futureColorRevenue = '#AFFF9A'; // Light Neon Green
            const pastColorEarnings = '#00E5FF'; // Neon Cyan
            const futureColorEarnings = '#9AFBFF'; // Light Neon Cyan
            const pastColorDebt = '#FF073A'; // Neon Pink/Red
            const futureColorDebt = '#FF9AB2'; // Light Neon Pink
            
            if (charts.financials) charts.financials.destroy();
            
            charts.financials = new Chart(financialsCtx, {
                type: 'bar',
                data: {
                    labels: annualLabels,
                    datasets: [
                        {
                            label: 'Revenue (Billion USD)',
                            data: revenueData,
                            backgroundColor: (context) => {
                                const year = context.chart.data.labels[context.dataIndex];
                                return parseInt(year) >= 2025 ? futureColorRevenue : pastColorRevenue;
                            },
                        },
                        {
                            label: 'Earnings (Billion USD)',
                            data: earningsData,
                            backgroundColor: (context) => {
                                const year = context.chart.data.labels[context.dataIndex];
                                return parseInt(year) >= 2025 ? futureColorEarnings : pastColorEarnings;
                            },
                        },
                        {
                            label: 'Debt (Billion USD)',
                            data: debtData,
                            backgroundColor: (context) => {
                                const year = context.chart.data.labels[context.dataIndex];
                                return parseInt(year) >= 2025 ? futureColorDebt : pastColorDebt;
                            },
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: { color: '#9CA3AF' },
                            grid: { display: false }
                        },
                        y: {
                            stacked: false,
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(55, 65, 81, 0.5)' },
                            title: {
                                display: true,
                                text: 'Billion USD',
                                color: '#9CA3AF'
                            }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#D1D5DB' } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>


